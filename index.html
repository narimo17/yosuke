<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HRãƒ»CS Analytics Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #e2e8f0;
      overflow-x: hidden;
      min-height: 100vh;
    }

    .dashboard {
      min-height: 100vh;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .dashboard.loaded { opacity: 1; transform: translateY(0); }

    .header {
      background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%);
      padding: 2rem 3rem;
      border-bottom: 3px solid rgba(139, 92, 246, 0.3);
      box-shadow: 0 10px 40px rgba(124, 58, 237, 0.2);
      position: relative;
      overflow: hidden;
    }
    .header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.05) 50%, transparent 70%);
      animation: shimmer 3s infinite;
    }
    @keyframes shimmer { 0% { transform: translateX(-100%);} 100% { transform: translateX(100%);} }

    .header-content { position: relative; z-index: 1; }
    .title {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 2px;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      font-size: 1rem;
      color: #c7d2fe;
      font-weight: 500;
      letter-spacing: 1px;
    }

    .tabs {
      display: flex;
      gap: 1rem;
      padding: 1.5rem 3rem;
      background: rgba(15, 23, 42, 0.5);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      flex-wrap: wrap;
    }
    .tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: 2px solid transparent;
      border-radius: 12px;
      color: #94a3b8;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      font-size: 0.95rem;
    }
    .tab:hover {
      color: #e2e8f0;
      border-color: rgba(139, 92, 246, 0.5);
      transform: translateY(-2px);
    }
    .tab.active {
      background: linear-gradient(135deg, #7c3aed 0%, #1e40af 100%);
      border-color: #8b5cf6;
      color: #fff;
      box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
    }

    .content { padding: 2rem 3rem; max-width: 1800px; margin: 0 auto; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .chart-container {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.8) 100%);
      padding: 2rem;
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.1);
      backdrop-filter: blur(10px);
      margin-bottom: 2rem;
      position: relative;
    }
    .chart-title {
      font-size: 1.5rem;
      font-weight: 800;
      color: #e2e8f0;
      margin-bottom: 1.25rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .muted { color:#94a3b8; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn {
      background: transparent;
      color:#cbd5e1;
      border:1px solid rgba(148,163,184,.25);
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight: 800;
    }
    .btn.primary {
      background: linear-gradient(135deg,#7c3aed,#1e40af);
      border-color:#8b5cf6;
      color:#fff;
    }
    .btn:active { transform: translateY(1px); }

    .pill {
      display:inline-flex;
      align-items:center;
      padding:2px 10px;
      border-radius:999px;
      font-weight:900;
      letter-spacing: .02em;
      color:#fff;
      font-size:12px;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 6px 18px rgba(0,0,0,0.22);
      line-height: 1.4;
      white-space: nowrap;
    }
    .pill.blue   { background: rgba(59,130,246,0.95); }
    .pill.yellow { background: rgba(245,158,11,0.95); }
    .pill.red    { background: rgba(239,68,68,0.95); }
    .pill.gray   { background: rgba(71,85,105,0.95); }

    /* ===== â‘  Executive summary ===== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 0.75rem;
    }
    .kpi-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.8) 100%);
      padding: 1.6rem;
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.1);
      backdrop-filter: blur(10px);
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }
    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 50px rgba(139, 92, 246, 0.22);
      border-color: rgba(139, 92, 246, 0.35);
    }
    .kpi-header { display:flex; align-items:center; gap: 1rem; margin-bottom: .8rem; }
    .kpi-icon {
      width: 44px; height: 44px; border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
      box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
      font-size: 1.3rem;
      flex: 0 0 auto;
    }
    .kpi-label { font-size: .85rem; color:#94a3b8; font-weight: 800; text-transform: uppercase; letter-spacing: .08em; }
    .kpi-value {
      font-size: 2.35rem;
      font-weight: 900;
      background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: .2rem;
      line-height: 1.05;
    }
    .kpi-sub { font-size: .9rem; color:#94a3b8; font-weight: 800; display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
    .kpi-trend-mini{
      margin-top: .45rem;
      font-size: .85rem;
      color:#cbd5e1;
      display:flex;
      gap:.6rem;
      align-items:center;
      flex-wrap:wrap;
      opacity: .9;
    }
    .deltaUp { color:#16a34a; font-weight: 900; }
    .deltaDown { color:#ef4444; font-weight: 900; }
    .deltaFlat { color:#94a3b8; font-weight: 900; }

    .metric-switch { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin: .35rem 0 0.75rem; }
    .metric-btn {
      padding: .45rem .75rem;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.18);
      color:#cbd5e1;
      cursor:pointer;
      font-weight: 900;
    }
    .metric-btn.active { background: linear-gradient(135deg,#7c3aed,#1e40af); border-color:#8b5cf6; color:#fff; }

    .ai-summary-grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: .75rem;
    }
    @media (max-width: 1100px){
      .ai-summary-grid{ grid-template-columns: 1fr; }
      .content{ padding: 1.25rem; }
      .header, .tabs{ padding-left: 1.25rem; padding-right: 1.25rem; }
    }
    .ai-card {
      background: rgba(2,6,23,.18);
      border: 1px solid rgba(148,163,184,.12);
      border-radius: 16px;
      padding: 1rem 1rem;
    }
    .ai-card h4 { font-size: 1rem; margin-bottom: .5rem; }
    .ai-card ul { padding-left: 1.2rem; line-height: 1.85; color:#cbd5e1; }
    .ai-card li { margin: .2rem 0; }

    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; }
    @media (max-width: 1100px){ .grid2{ grid-template-columns: 1fr; } }

    .panel {
      background: rgba(2,6,23,.18);
      border: 1px solid rgba(148,163,184,.12);
      border-radius: 16px;
      padding: 1rem 1rem;
    }
    .panel-title { font-weight: 900; margin-bottom: .75rem; color:#e2e8f0; display:flex; align-items:center; gap:.5rem; }
    .table { width:100%; border-collapse: collapse; overflow:hidden; border-radius: 12px; border: 1px solid rgba(148,163,184,0.12); }
    .table th, .table td {
      padding: .7rem .8rem;
      border-bottom: 1px solid rgba(148,163,184,0.10);
      vertical-align: top;
      font-size: .92rem;
      color: #cbd5e1;
      text-align: left;
    }
    .table th { background: rgba(2,6,23,.25); font-weight: 900; color: #e2e8f0; }
    .table tr:hover td { background: rgba(124,58,237,.08); }
    .link { color:#a5b4fc; text-decoration: underline; cursor:pointer; font-weight: 900; }

    details.low {
      margin-top: 1.25rem;
      background: rgba(2,6,23,.12);
      border: 1px dashed rgba(148,163,184,.18);
      border-radius: 16px;
      padding: .85rem 1rem;
    }
    details.low > summary {
      cursor: pointer;
      font-weight: 900;
      color:#cbd5e1;
      list-style: none;
    }
    details.low > summary::-webkit-details-marker { display:none; }
    details.low .hint { margin-top:.25rem; color:#94a3b8; font-size:.85rem; line-height: 1.6; }

    /* ===== â‘¡ Map tab ===== */
    .map-wrap { max-width: 1200px; margin: 0 auto; }
    .map-card { background: rgba(15,23,42,.6); border:1px solid rgba(148,163,184,.15); border-radius:16px; padding:14px; margin-top:12px; }
    #mapContainer2 {
      height: 600px; border-radius: 16px; overflow:hidden;
      background: linear-gradient(135deg, #111827 0%, #0b1220 100%);
      border:1px solid rgba(148,163,184,.15);
      position: relative;
    }
    #mapContainer2 svg { width:100%; height:100%; display:block; }

    #mapContainer2 svg .prefecture { cursor:pointer; transition: filter .15s ease; }
    #mapContainer2 svg .prefecture:hover { filter: brightness(1.15); }

    #mapContainer2 svg .prefecture path,
    #mapContainer2 svg .prefecture polygon {
      stroke: rgba(255, 255, 255, 0.22);
      stroke-width: 0.6;
      stroke-linejoin: round;
      stroke-linecap: round;
    }
    #mapContainer2 svg .boundary-line { opacity: 1; }
    #mapContainer2 svg .boundary-line line,
    #mapContainer2 svg .boundary-line path,
    #mapContainer2 svg .boundary-line polyline,
    #mapContainer2 svg .boundary-line polygon {
      stroke: rgba(255, 255, 255, 0.96) !important;
      stroke-width: 6 !important;
      stroke-linejoin: round;
      stroke-linecap: round;
      filter:
        drop-shadow(0 0 0 rgba(0, 0, 0, 0.90))
        drop-shadow(0 0 1.2px rgba(0, 0, 0, 0.85))
        drop-shadow(0 0 2.2px rgba(0, 0, 0, 0.70));
    }
    #mapContainer2 [data-code="47"] { display:none; }

    textarea {
      width:100%; background: rgba(2,6,23,.6); color:#e5e7eb;
      border:1px solid rgba(148,163,184,.2); border-radius:12px;
      padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px; line-height:1.35;
      tab-size: 2;
      white-space: pre;
    }
    .grid2txt { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 900px) { .grid2txt { grid-template-columns: 1fr; } #mapContainer2{ height:420px; } }

    #prefPopup2 {
      position:absolute;
      display:none;
      min-width:260px;
      max-width:560px;
      max-height: 420px;
      overflow:auto;
      background:rgba(0,0,0,0.88);
      color:#fff;
      border:1px solid rgba(148,163,184,0.25);
      border-radius:12px;
      padding:12px;
      z-index:50;
      box-shadow: 0 12px 40px rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
    }
    .popupSiteBtn {
      width:100%;
      text-align:left;
      background:rgba(30,41,59,0.35);
      border:1px solid rgba(148,163,184,0.15);
      color:#fff;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
    }
    .popupSiteBtn:hover { filter: brightness(1.08); }
    .kv { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:6px; font-size:12px; color:#cbd5e1; }
    .kv b { color:#fff; }

    /* modal A (map detail) */
    #siteDetailModal2 { position: fixed; inset: 0; display: none; z-index: 200; }
    #siteDetailModal2.is-open { display:block; }
    .modalBackdrop{ position:absolute; inset:0; background: rgba(2,6,23,0.78); backdrop-filter: blur(2px); }
    .modalPanel{
      position:absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
      width: min(1080px, calc(100vw - 28px));
      max-height: min(86vh, 900px);
      overflow:auto;
      background: rgba(255,255,255,0.98);
      color:#0f172a;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.55);
      border: 1px solid rgba(15,23,42,0.10);
    }
    .modalHeader{
      position: sticky; top: 0;
      background: rgba(255,255,255,0.98);
      border-bottom: 1px solid rgba(15,23,42,0.08);
      padding: 12px 14px;
      display:flex; align-items:center; gap:10px;
      z-index: 5;
    }
    .modalTitle{ font-weight: 900; font-size: 18px; }
    .modalHeader .muted{ color:#475569; }
    .modalCloseBtn{
      margin-left:auto;
      background:#0f172a;
      border-color:#0f172a;
      color:#fff;
      border-radius: 10px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 900;
    }
    .modalBody{ padding: 12px 14px 14px 14px; }
    .selectBar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom: 10px; }
    select {
      background: #fff;
      border: 1px solid rgba(15,23,42,0.14);
      border-radius: 10px;
      padding: 8px 10px;
      font: inherit;
      min-width: 280px;
    }
    @media (max-width: 560px) { select { min-width: 100%; } }

    .kpiGrid {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin: 10px 0 12px 0;
    }
    @media (max-width: 1100px) { .kpiGrid{ grid-template-columns: repeat(2,1fr);} }
    @media (max-width: 560px) { .kpiGrid{ grid-template-columns: 1fr;} }

    .kpiCard{
      border: 1px solid rgba(15,23,42,0.10);
      border-radius: 14px;
      background: #fff;
      padding: 12px;
    }
    .kpiLabel{ font-size: 12px; color:#475569; font-weight:800; }
    .kpiValue{ font-size: 22px; font-weight: 900; margin-top: 6px; }
    .kpiDelta{ margin-top: 6px; font-size: 12px; font-weight: 800; }

    .detailGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 900px){ .detailGrid{ grid-template-columns: 1fr; } }

    .panelW{
      border: 1px solid rgba(15,23,42,0.10);
      border-radius: 14px;
      background:#fff;
      padding: 12px;
      min-height: 160px;
    }
    .panelTitleW{ font-weight: 900; margin-bottom: 8px; }
    .panelW ul, .panelW ol{ margin: 6px 0 0 18px; line-height: 1.8; }
    .panelW li{ margin: 4px 0; }

    /* ===== â‘¢ Improve tab ===== */
    .select, .input{
      background: rgba(2,6,23,.25);
      border: 1px solid rgba(148, 163, 184, 0.18);
      color: #e2e8f0;
      padding: 0.55rem 0.7rem;
      border-radius: 12px;
      outline: none;
      font-weight: 700;
    }

    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.25rem;
      margin: 1rem 0 1.25rem;
    }
    .analysis-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.75) 0%, rgba(15, 23, 42, 0.75) 100%);
      padding: 1.5rem;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.12);
      text-align: center;
      position: relative;
    }
    .analysis-count {
      font-size: 3rem;
      font-weight: 900;
      background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.35rem;
      line-height: 1;
    }
    .analysis-label {
      font-size: 1rem;
      color: #94a3b8;
      font-weight: 700;
      margin-bottom: 0.75rem;
    }
    .keyword-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
    .keyword-tag {
      padding: 0.45rem 0.9rem;
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.4);
      border-radius: 999px;
      font-size: 0.85rem;
      color: #c7d2fe;
      font-weight: 800;
    }
    .clickable { cursor: pointer; }
    .clickable:hover { border-color: rgba(239,68,68,0.35); box-shadow: 0 12px 40px rgba(239,68,68,0.10); }

    .popover {
      position: absolute;
      z-index: 2000;
      width: min(680px, calc(100vw - 64px));
      max-height: 420px;
      overflow: auto;
      background: rgba(2,6,23,0.92);
      border: 1px solid rgba(148,163,184,0.20);
      border-radius: 16px;
      box-shadow: 0 22px 80px rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
      display: none;
    }
    .popover.active { display: block; }
    .pop-header{
      position: sticky;
      top: 0;
      background: linear-gradient(135deg, rgba(15,23,42,.98) 0%, rgba(2,6,23,.98) 100%);
      border-bottom: 1px solid rgba(148,163,184,0.16);
      padding: .85rem 1rem;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: .75rem;
    }
    .pop-title{ font-weight: 1000; }
    .pop-close{
      background: transparent;
      border: 1px solid rgba(148,163,184,0.25);
      color: #e2e8f0;
      border-radius: 10px;
      padding: .35rem .6rem;
      cursor: pointer;
      font-weight: 900;
    }
    .pop-body{ padding: 1rem; }
    .ng-item{
      background: rgba(148,163,184,0.10);
      border: 1px solid rgba(148,163,184,0.14);
      border-radius: 14px;
      padding: .85rem .9rem;
      margin-bottom: .75rem;
    }
    .ng-meta{
      color:#94a3b8;
      font-size: .85rem;
      margin-bottom: .35rem;
      display:flex;
      flex-wrap:wrap;
      gap: .35rem .6rem;
      align-items:center;
    }
    .ng-text{ color:#e5e7eb; line-height: 1.7; }
    .badge-red{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.25); }
    .badge-blue{ background: rgba(59,130,246,.14); border-color: rgba(59,130,246,.25); }
    .badge-amber{ background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.25); }
    mark{ background: rgba(245,158,11,.25); color:#fff; padding: 0 .15rem; border-radius: .25rem; }

    /* ===== â‘£ AI voice mining ===== */
    .comment-list { display: flex; flex-direction: column; gap: 1rem; }
    .comment-card {
      background: rgba(30, 41, 59, 0.6);
      padding: 1.5rem;
      border-radius: 12px;
      border-left: 4px solid #8b5cf6;
      transition: all 0.3s ease;
    }
    .comment-card:hover { transform: translateX(4px); border-left-color: #3b82f6; }
    .comment-category {
      font-size: 0.75rem;
      color: #8b5cf6;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 0.5rem;
    }
    .comment-text { color: #cbd5e1; line-height: 1.6; }

    /* ===== â‘¤ Talent ===== */
    .performers-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
    }
    .performer-card{
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.8) 100%);
      padding: 1.5rem;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.1);
      transition: all 0.3s ease;
    }
    .performer-card:hover{
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.5);
    }
    .performer-badge{
      display:inline-block;
      padding: .25rem .75rem;
      border-radius: 20px;
      color:#fff;
      font-size: .75rem;
      font-weight:900;
      text-transform: uppercase;
      letter-spacing: .5px;
      margin-bottom: 1rem;
    }
    .performer-info{ display:flex; flex-direction:column; gap:.5rem; }
    .performer-name{ font-size: 1.125rem; font-weight:900; color:#e2e8f0; }
    .performer-detail{ font-size: .875rem; color:#94a3b8; font-weight: 700; }
    .action-box{
      margin-top: 2rem;
      padding: 1.5rem;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .action-title{
      color: #10b981;
      margin-bottom: 1rem;
      display:flex;
      align-items:center;
      gap:.5rem;
      font-size: 1.1rem;
      font-weight: 900;
    }
    .action-box ul{ color: #cbd5e1; line-height: 2; padding-left: 1.5rem; }

    .section-title{
      margin: 1.5rem 0 1rem;
      color:#e2e8f0;
      font-size: 1.1rem;
      font-weight: 900;
    }
    .small-note{
      margin-top: .75rem;
      color: #94a3b8;
      font-size: .85rem;
      line-height: 1.6;
    }
    code.kbd{
      background: rgba(148, 163, 184, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.18);
      padding: 0.1rem 0.4rem;
      border-radius: 8px;
      color: #e2e8f0;
    }
  </style>
</head>

<body>
  <div class="dashboard" id="dashboard">
    <div class="header">
      <div class="header-content">
        <h1 class="title">HRãƒ»CS Analytics Dashboard</h1>
        <p class="subtitle">â‘ ã‚µãƒãƒªãƒ¼ / â‘¡ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— / â‘¢è¦æ”¹å–„ / â‘£AIãƒœã‚¤ã‚¹ / â‘¤ã‚¿ãƒ¬ãƒ³ãƒˆ</p>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('overview', this)">ğŸ“Š â‘  ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼</button>
      <button class="tab" onclick="switchTab('map', this)">ğŸ—¾ â‘¡ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</button>
      <button class="tab" onclick="switchTab('improve', this)">ğŸš¨ â‘¢ è¦æ”¹å–„ãƒªãƒ¼ãƒ€ãƒ¼ãƒ»æ‹ ç‚¹</button>
      <button class="tab" onclick="switchTab('comments', this)">ğŸ’¬ â‘£ AIãƒœã‚¤ã‚¹ãƒã‚¤ãƒ‹ãƒ³ã‚°</button>
      <button class="tab" onclick="switchTab('talent', this)">ğŸ† â‘¤ ã‚¿ãƒ¬ãƒ³ãƒˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ</button>
    </div>

    <div class="content">

      <!-- ================= â‘  Executive summary ================= -->
      <div id="overview" class="tab-content active">
        <div class="chart-container">
          <h3 class="chart-title">ğŸ“Š ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼</h3>

          <!-- hero KPIs -->
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-header">
                <div class="kpi-icon">ğŸ‘¥</div>
                <div><div class="kpi-label">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…</div></div>
              </div>
              <div class="kpi-value" id="ovKpiResponses">â€”</div>
              <div class="kpi-sub"><span class="muted">å¯¾è±¡æœˆ</span><span id="ovKpiMonthLabel">â€”</span></div>
              <div class="kpi-trend-mini">
                <span class="muted">å‰æœˆæ¯”</span><span id="ovDeltaResponses" class="deltaFlat">â€”</span>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-header">
                <div class="kpi-icon">ğŸ¯</div>
                <div><div class="kpi-label">æ¬¡å›äºˆç´„ç‡</div></div>
              </div>
              <div class="kpi-value" id="ovKpiReserve">â€”</div>
              <div class="kpi-sub"><span class="muted">å›ç­”æ•°</span><span id="ovKpiReserveN">â€”</span><span class="muted">ï¼ˆ1ã€œ5å›ç›®ï¼‰</span></div>
              <div class="kpi-trend-mini">
                <span class="muted">å‰æœˆæ¯”</span><span id="ovDeltaReserve" class="deltaFlat">â€”</span>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-header">
                <div class="kpi-icon">â­</div>
                <div><div class="kpi-label">æº€è¶³åº¦å¹³å‡</div></div>
              </div>
              <div class="kpi-value" id="ovKpiSat">â€”</div>
              <div class="kpi-sub"><span class="muted">å›ç­”æ•°</span><span id="ovKpiSatN">â€”</span></div>
              <div class="kpi-trend-mini">
                <span class="muted">å‰æœˆæ¯”</span><span id="ovDeltaSat" class="deltaFlat">â€”</span>
              </div>
            </div>
          </div>

          <div class="metric-switch" style="margin-top:.25rem;">
            <span class="muted" style="font-weight:900;">æŒ‡æ¨™åˆ‡æ›¿ï¼š</span>
            <button class="metric-btn active" id="ov-metric-next" type="button">äºˆç´„ç‡</button>
            <button class="metric-btn" id="ov-metric-sat" type="button">æº€è¶³åº¦</button>
            <button class="metric-btn" id="ov-metric-greet" type="button">æŒ¨æ‹¶ï¼ˆãªã—ç‡ï¼‰</button>
            <span style="flex:1"></span>
            <span class="muted" style="font-weight:900;">æœˆï¼š</span>
            <button class="metric-btn active" id="ov-month-curr" type="button">ä»Šæœˆ</button>
            <button class="metric-btn" id="ov-month-prev" type="button">å…ˆæœˆ</button>
            <span class="muted" id="ov-dataStatus"></span>
          </div>

          <div class="ai-summary-grid">
            <div class="ai-card">
              <h4>å…¨ä½“ã®èª²é¡Œ</h4>
              <ul id="ovAiIssues"></ul>
            </div>
            <div class="ai-card">
              <h4>åŸå› </h4>
              <ul id="ovAiCauses"></ul>
            </div>
            <div class="ai-card">
              <h4>æ‰“ã¡æ‰‹</h4>
              <ul id="ovAiActions"></ul>
            </div>
            <div class="ai-card">
              <h4>å‚¾å‘</h4>
              <ul id="ovAiTrends"></ul>
            </div>
          </div>

          <div class="grid2">
            <div class="panel">
              <div class="panel-title">ğŸ“ˆ å‰æœˆã‹ã‚‰ã®æ”¹å–„ Top5æ‹ ç‚¹ï¼ˆæŒ‡æ¨™åˆ‡æ›¿ã«é€£å‹•ï¼‰</div>
              <table class="table" id="ovImproveTop5"></table>
              <div class="muted" style="margin-top:.5rem; font-size:.85rem;">â€»ã‚¯ãƒªãƒƒã‚¯ã§â‘¡ã®æ‹ ç‚¹è©³ç´°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã¸</div>
            </div>

            <div class="panel">
              <div class="panel-title">ğŸ“ˆ å‰æœˆã‹ã‚‰ã®æ”¹å–„ãƒ¯ãƒ¼ã‚¹ãƒˆ5æ‹ ç‚¹ï¼ˆæŒ‡æ¨™åˆ‡æ›¿ã«é€£å‹•ï¼‰</div>
              <table class="table" id="ovWorst5"></table>
              <div class="muted" style="margin-top:.5rem; font-size:.85rem;">â€»ã‚¯ãƒªãƒƒã‚¯ã§â‘¡ã®æ‹ ç‚¹è©³ç´°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã¸</div>
            </div>

            <div class="panel">
              <div class="panel-title">ğŸŒŸ æ¨ã—ãƒªãƒ¼ãƒ€ãƒ¼ Top5ï¼ˆæ‹ ç‚¹åï¼‰</div>
              <table class="table" id="ovOshiTop5"></table>
              <div class="muted" style="margin-top:.5rem; font-size:.85rem;">â€»ã“ã®çµ±åˆç‰ˆã§ã¯ãƒ¢ãƒƒã‚¯ï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿åˆ—ã«æ¥ç¶šäºˆå®šï¼‰</div>
            </div>

            <div class="panel">
              <div class="panel-title">ğŸšª å„ã‚¿ãƒ–ã¸ã®å…¥å£</div>
              <div class="row" style="margin-top:.25rem;">
                <button class="btn primary" type="button" onclick="switchTab('map', document.querySelectorAll('.tab')[1])">â‘¡ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã¸</button>
                <button class="btn" type="button" onclick="switchTab('improve', document.querySelectorAll('.tab')[2])">â‘¢è¦æ”¹å–„ã¸</button>
                <button class="btn" type="button" onclick="switchTab('comments', document.querySelectorAll('.tab')[3])">â‘£AIãƒœã‚¤ã‚¹ã¸</button>
                <button class="btn" type="button" onclick="switchTab('talent', document.querySelectorAll('.tab')[4])">â‘¤ã‚¿ãƒ¬ãƒ³ãƒˆã¸</button>
              </div>
              <div class="muted" style="margin-top:.75rem; line-height: 1.8;">
                ãƒ»â‘ ã®ã€ŒæŒ‡æ¨™åˆ‡æ›¿ã€ã¯â‘¡ã®é–¾å€¤ï¼ˆé’/é»„/èµ¤/ç°ï¼‰ã¨åŒã˜ãƒ«ãƒ¼ãƒ«<br>
                ãƒ»Top/Worstã¯ã€Œå‰æœˆæ¯”ï¼ˆÎ”ï¼‰ã€ã§ç®—å‡ºï¼ˆæŒ¨æ‹¶ãªã—ç‡ã¯æ¸›å°‘ãŒæ”¹å–„ï¼‰<br>
                ãƒ»ãƒ‡ãƒ¼ã‚¿ã¯â‘¡ã®è²¼ã‚Šä»˜ã‘TSVã‹ã‚‰ç”Ÿæˆï¼ˆä»Šæœˆ/å…ˆæœˆï¼‰ã¾ãŸã¯ãƒ€ãƒŸãƒ¼
              </div>
            </div>
          </div>

          <details class="low">
            <summary>ï¼ˆæ§ãˆã‚ï¼‰TSV/CSVè²¼ã‚Šä»˜ã‘ï¼ˆâ‘ ã§ã‚‚æ›´æ–°ã§ãã¾ã™ï¼‰</summary>
            <div class="hint">
              â‘¡ã®å…¥åŠ›æ¬„ã¨åŒã˜å†…å®¹ã‚’ã“ã“ã«è²¼ã£ã¦ã‚‚OKã§ã™ã€‚<br>
              â€»ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã¯â‘¡ã¸é£›ã°ãšã«å†…éƒ¨ã ã‘æ›´æ–°ã—ã¾ã™ï¼ˆåœ°å›³ã‚‚â‘ ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚‚æ›´æ–°ï¼‰ã€‚
            </div>

            <div class="grid2txt" style="margin-top:.75rem;">
              <div>
                <div class="muted" style="margin:6px 0;">å…ˆæœˆ 1ã€œ5å›ç›®</div>
                <textarea id="ovTsvPrev1to5" rows="7"></textarea>
              </div>
              <div>
                <div class="muted" style="margin:6px 0;">å…ˆæœˆ 6ã€œ10å›ç›®</div>
                <textarea id="ovTsvPrev6to10" rows="7"></textarea>
              </div>
              <div>
                <div class="muted" style="margin:6px 0;">ä»Šæœˆ 1ã€œ5å›ç›®</div>
                <textarea id="ovTsvCurr1to5" rows="7"></textarea>
              </div>
              <div>
                <div class="muted" style="margin:6px 0;">ä»Šæœˆ 6ã€œ10å›ç›®</div>
                <textarea id="ovTsvCurr6to10" rows="7"></textarea>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <button id="ovBtnLoad" class="btn primary" type="button">è²¼ã‚Šä»˜ã‘å†…å®¹ã§æ›´æ–°ï¼ˆâ‘ ï¼‰</button>
              <button id="ovBtnFillDummy" class="btn" type="button">ãƒ€ãƒŸãƒ¼è‡ªå‹•å…¥åŠ›ï¼ˆå„æœˆ3000ä»¶ãƒ»é«˜é€Ÿï¼‰</button>
              <div id="ovLoadStatus" class="muted"></div>
            </div>
          </details>

        </div>
      </div>

      <!-- ================= â‘¡ Map ================= -->
      <div id="map" class="tab-content">
        <div class="chart-container map-wrap">
          <h3 class="chart-title">ğŸ—¾ éƒ½é“åºœçœŒãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆçœŒã‚¿ãƒƒãƒ—ã§å¹ãå‡ºã—ï¼‰</h3>

          <div class="row">
            <span class="muted" style="font-weight:900;">æŒ‡æ¨™ï¼š</span>
            <button id="metric-next" class="btn primary" type="button">äºˆç´„ç‡</button>
            <button id="metric-sat" class="btn" type="button">æº€è¶³åº¦</button>
            <button id="metric-greet" class="btn" type="button">æŒ¨æ‹¶ï¼ˆãªã—ç‡ï¼‰</button>
            <span style="flex:1"></span>
            <span class="muted" style="font-weight:900;">æœˆï¼š</span>
            <button id="month-curr" class="btn primary" type="button">ä»Šæœˆ</button>
            <button id="month-prev" class="btn" type="button">å…ˆæœˆ</button>
          </div>

          <div class="map-card">
            <div id="mapContainer2">
              <div id="prefPopup2">
                <div style="display:flex;gap:8px;align-items:center;">
                  <div id="prefPopupTitle2" style="font-weight:900;"></div>
                  <div style="flex:1"></div>
                  <button id="prefPopupClose2" type="button" class="btn" style="padding:2px 8px;border-radius:8px;">Ã—</button>
                </div>
                <div id="prefPopupMeta2" class="kv"></div>
                <div id="prefPopupSites2" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;"></div>
                <div id="prefPopupMore2" class="muted" style="margin-top:8px;font-size:12px;"></div>
              </div>
            </div>
            <div id="mapStatus2" class="muted" style="margin-top:10px;"></div>
            <div class="muted" style="margin-top:6px;font-size:12px;">
              â€» çœŒã‚¿ãƒƒãƒ—ã§å¹ãå‡ºã—è¡¨ç¤ºã€‚å¹ãå‡ºã—å¤–ï¼ˆåœ°å›³èƒŒæ™¯ï¼‰ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã¾ã™ã€‚
            </div>
          </div>

          <div class="map-card">
            <div style="font-weight:800;margin-bottom:8px;">TSV/CSVè²¼ã‚Šä»˜ã‘ï¼ˆãƒ˜ãƒƒãƒ€å¿…é ˆï¼‰</div>
            <div class="grid2txt">
              <div>
                <div class="muted" style="margin:6px 0;">å…ˆæœˆ 1ã€œ5å›ç›®</div>
                <textarea id="tsvPrev1to5" rows="10"></textarea>
              </div>
              <div>
                <div class="muted" style="margin:6px 0;">å…ˆæœˆ 6ã€œ10å›ç›®</div>
                <textarea id="tsvPrev6to10" rows="10"></textarea>
              </div>
              <div>
                <div class="muted" style="margin:6px 0;">ä»Šæœˆ 1ã€œ5å›ç›®</div>
                <textarea id="tsvCurr1to5" rows="10"></textarea>
              </div>
              <div>
                <div class="muted" style="margin:6px 0;">ä»Šæœˆ 6ã€œ10å›ç›®</div>
                <textarea id="tsvCurr6to10" rows="10"></textarea>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <button id="btnLoad" class="btn primary" type="button">è²¼ã‚Šä»˜ã‘å†…å®¹ã§æ›´æ–°</button>
              <button id="btnFillDummy" class="btn" type="button">ãƒ€ãƒŸãƒ¼ç”Ÿæˆï¼ˆå„æœˆ3000ä»¶ãƒ»é«˜é€Ÿï¼‰</button>
              <div id="loadStatus" class="muted"></div>
            </div>
            <div id="unknownBox" class="muted" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>

      <!-- ================= â‘¢ Improve ================= -->
      <div id="improve" class="tab-content">
        <div class="chart-container">
          <h3 class="chart-title">ğŸš¨ è¦æ”¹å–„ãƒªãƒ¼ãƒ€ãƒ¼ãƒ»æ‹ ç‚¹ï¼ˆNGãƒ¯ãƒ¼ãƒ‰ Ã— ã¾ãŸåƒããŸã„=ã„ã„ãˆï¼‰</h3>

          <div style="display:flex; gap:.75rem; flex-wrap:wrap; align-items:center; margin-bottom: 0.25rem;">
            <span style="color:#94a3b8; font-weight:800;">æœŸé–“</span>
            <select id="impDaysSel" class="select">
              <option value="30">ç›´è¿‘30æ—¥ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰</option>
              <option value="90">ç›´è¿‘90æ—¥ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰</option>
              <option value="365">ç›´è¿‘365æ—¥ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰</option>
            </select>

            <span style="color:#94a3b8; font-weight:800;">æ¤œç´¢</span>
            <input id="impQuery" class="input" placeholder="ä¾‹ï¼šæ–°å®¿ / ç”°ä¸­ / ç„¡è¦–" style="min-width: 280px;">

            <button class="btn primary" id="impApplyBtn">åæ˜ </button>
          </div>

          <div class="analysis-grid">
            <div class="analysis-card clickable" id="ngCard" title="ã‚¯ãƒªãƒƒã‚¯ã§NGãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ï¼ˆå›ç­”7ä»¶ï¼‰ã‚’è¡¨ç¤º">
              <div class="analysis-count" id="kpiNg">â€”</div>
              <div class="analysis-label">NGãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥</div>
              <div class="keyword-tags">
                <span class="keyword-tag">ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°</span>
              </div>
            </div>
          </div>

          <div class="grid2">
            <div class="panel">
              <div class="panel-title">è¦æ”¹å–„ãƒªãƒ¼ãƒ€ãƒ¼ï¼ˆä¸Šä½ï¼‰</div>
              <table class="table" id="leaderTable"></table>
              <div style="color:#94a3b8; margin-top:.5rem; font-size:.85rem;">â€»ï¼ˆæ‹ ç‚¹åï¼‰ã¯ã€Œã„ã„ãˆç‡ãŒæœ€æ‚ªã®æ‹ ç‚¹ã€</div>
            </div>

            <div class="panel">
              <div class="panel-title">è¦æ”¹å–„æ‹ ç‚¹ï¼ˆä¸Šä½ï¼‰</div>
              <table class="table" id="siteTable"></table>
              <div class="muted" style="margin-top:.5rem; font-size:.85rem;">â€»ä¸¦ã³é †ã¯ã€Œã„ã„ãˆä»¶æ•°ãŒå¤šã„é †ã€</div>
            </div>
          </div>

          <div class="popover" id="ngPopover" role="dialog" aria-modal="false" aria-label="NGãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥è©³ç´°">
            <div class="pop-header">
              <div class="pop-title" id="popTitle">NGãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ï¼ˆå›ç­”å˜ä½ï¼‰</div>
              <button class="pop-close" id="popCloseBtn">é–‰ã˜ã‚‹</button>
            </div>
            <div class="pop-body" id="popBody"></div>
          </div>
        </div>
      </div>

      <!-- ================= â‘£ AI voice mining ================= -->
      <div id="comments" class="tab-content">
        <div class="chart-container">
          <h3 class="chart-title">ğŸ’¬ AIãƒœã‚¤ã‚¹ãƒã‚¤ãƒ‹ãƒ³ã‚°ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰</h3>

          <div class="analysis-grid">
            <div class="analysis-card">
              <div class="analysis-count">324</div>
              <div class="analysis-label">ãƒã‚¸ãƒ†ã‚£ãƒ–</div>
              <div class="keyword-tags">
                <span class="keyword-tag">ã‚„ã‚ŠãŒã„</span>
                <span class="keyword-tag">æ¥½ã—ã„</span>
                <span class="keyword-tag">å‹‰å¼·ã«ãªã‚‹</span>
                <span class="keyword-tag">äººé–“é–¢ä¿‚ãŒè‰¯ã„</span>
              </div>
            </div>

            <div class="analysis-card">
              <div class="analysis-count">156</div>
              <div class="analysis-label">æ”¹å–„è¦æœ›</div>
              <div class="keyword-tags">
                <span class="keyword-tag">é€£çµ¡ãŒé…ã„</span>
                <span class="keyword-tag">æŒ‡ç¤ºãŒä¸æ˜ç¢º</span>
                <span class="keyword-tag">æ ã‚’å¢—ã‚„ã—ã¦</span>
                <span class="keyword-tag">ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ </span>
              </div>
            </div>

            <div class="analysis-card">
              <div class="analysis-count">20</div>
              <div class="analysis-label">ãƒã‚¬ãƒ†ã‚£ãƒ–</div>
              <div class="keyword-tags">
                <span class="keyword-tag">è¾ã‚ãŸã„</span>
                <span class="keyword-tag">ä¸æº€</span>
                <span class="keyword-tag">æ”¹å–„ã•ã‚Œãªã„</span>
              </div>
            </div>
          </div>

          <div class="chart-container" style="padding:0;border:none;background:transparent;margin:0;">
            <h3 class="chart-title" style="margin-top:.5rem;">ğŸ’¬ AIã«ã‚ˆã‚‹è‡ªå‹•åˆ†æçµæœ</h3>
            <div class="comment-list">
              <div class="comment-card">
                <div class="comment-category">æ”¹å–„æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
                <div class="comment-text">
                  âœ… <strong>é€£çµ¡ä½“åˆ¶ã®å¼·åŒ–:</strong> ã€Œé€£çµ¡ãŒé…ã„ã€ã¨ã®æŒ‡æ‘˜ãŒå¤šæ•°ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥ã‚’æ¨å¥¨ã€‚
                </div>
              </div>
              <div class="comment-card">
                <div class="comment-category">æ”¹å–„æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
                <div class="comment-text">
                  âœ… <strong>ä½œæ¥­æŒ‡ç¤ºã®æ¨™æº–åŒ–:</strong> ã€ŒæŒ‡ç¤ºãŒä¸æ˜ç¢ºã€ã¨ã®å£°ã‚ã‚Šã€‚ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ•´å‚™ã¨ãƒªãƒ¼ãƒ€ãƒ¼ç ”ä¿®ã‚’å®Ÿæ–½ã€‚
                </div>
              </div>
              <div class="comment-card">
                <div class="comment-category">æ”¹å–„æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
                <div class="comment-text">
                  âœ… <strong>ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†:</strong> è‡­ã„ã‚„ç—›ã¿ã«é–¢ã™ã‚‹ä¸æº€ãŒæ•£è¦‹ã€‚å®šæœŸçš„ãªäº¤æ›ã‚µã‚¤ã‚¯ãƒ«ã®è¦‹ç›´ã—ãŒå¿…è¦ã€‚
                </div>
              </div>
              <div class="comment-card">
                <div class="comment-category">å¼·ã¿</div>
                <div class="comment-text">
                  ğŸ¯ <strong>äººé–“é–¢ä¿‚ã®è‰¯ã•:</strong> ã€Œäººé–“é–¢ä¿‚ãŒè‰¯ã„ã€ã€Œãƒªãƒ¼ãƒ€ãƒ¼ãŒè¦ªåˆ‡ã€ãªã©ã€ãƒãƒ¼ãƒ ç’°å¢ƒã¸ã®é«˜è©•ä¾¡å¤šæ•°ã€‚ã“ã®å¼·ã¿ã‚’æ¡ç”¨PRã«æ´»ç”¨å¯èƒ½ã€‚
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ================= â‘¤ Talent ================= -->
      <div id="talent" class="tab-content">
        <div class="chart-container">
          <h3 class="chart-title">ğŸ† ã‚¿ãƒ¬ãƒ³ãƒˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆï¼ˆç¢ºèªç”¨ãƒ»å˜ä½“ï¼‰</h3>

          <div class="analysis-grid">
            <div class="analysis-card">
              <div class="analysis-count" id="hpCount">â€”</div>
              <div class="analysis-label">ç¤¾å“¡å‹§èª˜å€™è£œ</div>
              <div class="keyword-tags" id="hpRuleTag"></div>
            </div>
            <div class="analysis-card">
              <div class="analysis-count" id="almostCount">â€”</div>
              <div class="analysis-label">è‚²æˆ/è¦è¦³å¯Ÿ</div>
              <div class="keyword-tags" id="almostTag"></div>
            </div>
          </div>

          <div class="section-title">ç¤¾å“¡å‹§èª˜å€™è£œãƒªã‚¹ãƒˆï¼ˆ4åï¼‰</div>
          <div class="performers-grid" id="hpGrid"></div>

          <div class="section-title">è‚²æˆ/è¦è¦³å¯Ÿï¼ˆ4åï¼‰</div>
          <div class="performers-grid" id="almostGrid"></div>

          <div class="action-box">
            <h4 class="action-title">ğŸ“Œ æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰</h4>
            <ul id="hpActions"></ul>
            <div class="small-note">
              â€»ã“ã®çµ±åˆç‰ˆã§ã¯å›ºå®šãƒ€ãƒŸãƒ¼ã§ã™ã€‚å°†æ¥ã¯TSV/CSVå–ã‚Šè¾¼ã¿ã«å·®ã—æ›¿ãˆå¯èƒ½ã€‚<br/>
              â€»ã€Œè¶³åˆ‡ã‚Šã€ã¯ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿ã§ã€ç”»é¢ã«ã¯è¡¨ç¤ºã—ã¦ã„ã¾ã›ã‚“ï¼ˆç¤¾å“¡å‹§èª˜å€™è£œã‹ã‚‰é™¤å¤–ï¼‰ã€‚
            </div>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /dashboard -->

  <!-- ================= â‘¡ Map modal A ================= -->
  <div id="siteDetailModal2" aria-hidden="true">
    <div class="modalBackdrop" data-close="1"></div>
    <div class="modalPanel" role="dialog" aria-modal="true" aria-label="æ‹ ç‚¹è©³ç´°">
      <div class="modalHeader">
        <div class="modalTitle">ã‚¢ãƒ«ãƒã‚¤ãƒˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
        <div id="modalSubTitle2" class="muted"></div>
        <button id="btnCloseModal2" class="modalCloseBtn" type="button">â† åœ°å›³ã«æˆ»ã‚‹</button>
      </div>
      <div id="modalBody2" class="modalBody"></div>
    </div>
  </div>

  <script>
    /* =========================================================
      Global: stable tab switching
    ========================================================= */
    function switchTab(tabName, btnEl) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      if (btnEl) btnEl.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const target = document.getElementById(tabName);
      if (target) target.classList.add('active');

      if (tabName === 'map' && window.__MAP_INIT_DONE__ !== true) {
        window.__MAP_INIT_DONE__ = true;
        initMapTab();
      }
    }

    window.addEventListener('load', () => {
      document.getElementById('dashboard').classList.add('loaded');
      initImproveTab();
      initTalentTab();
      initOverviewTab();
    });

    /* =========================================================
      â‘¢ Improve tab
    ========================================================= */
    function initImproveTab() {
      document.getElementById("impApplyBtn").addEventListener("click", applyImprove);

      document.getElementById("ngCard").addEventListener("click", (e) => {
        toggleNgPopover(e.currentTarget);
      });

      document.getElementById("popCloseBtn").addEventListener("click", closePopover);
      document.addEventListener("click", (e) => {
        const pop = document.getElementById("ngPopover");
        if (!pop.classList.contains("active")) return;
        const card = document.getElementById("ngCard");
        if (pop.contains(e.target) || card.contains(e.target)) return;
        closePopover();
      });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") closePopover(); });

      applyImprove();
    }

    const improveRows = [
      { at:"2026-01-18T10:12:00+09:00", siteName:"æ–°å®¿æ”¯åº—", leaderName:"ç”°ä¸­", workAgain:"ã„ã„ãˆ", comment:"ç„¡è¦–ã•ã‚ŒãŸã€‚è³ªå•ã—ã¦ã‚‚è¿”äº‹ãŒãªã„ã€‚" },
      { at:"2026-01-20T12:40:00+09:00", siteName:"æ–°å®¿æ”¯åº—", leaderName:"ç”°ä¸­", workAgain:"ã„ã„ãˆ", comment:"è©°ã‚ã‚‰ã‚Œã¦æ€–ã‹ã£ãŸã€‚" },
      { at:"2026-01-22T09:10:00+09:00", siteName:"æ–°å®¿æ”¯åº—", leaderName:"ç”°ä¸­", workAgain:"ã¯ã„",   comment:"å¿™ã—ã„ãŒæŒ‡ç¤ºã¯çš„ç¢ºã€‚" },
      { at:"2026-01-25T18:25:00+09:00", siteName:"æ–°å®¿æ”¯åº—", leaderName:"ç”°ä¸­", workAgain:"ã„ã„ãˆ", comment:"è¹´ã‚‰ã‚ŒãŸã¨æ„Ÿã˜ãŸï¼ˆèº«ä½“çš„æ¥è§¦ãŒã‚ã£ãŸï¼‰ã€‚" },

      { at:"2026-01-19T11:05:00+09:00", siteName:"é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName:"ä½è—¤", workAgain:"ã„ã„ãˆ", comment:"æ€’é³´ã‚‰ã‚ŒãŸã€‚èç¸®ã™ã‚‹ã€‚" },
      { at:"2026-01-28T15:12:00+09:00", siteName:"é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName:"ä½è—¤", workAgain:"ã¯ã„",   comment:"æ”¹å–„ã—ã¦ãã¦ã„ã‚‹ã€‚" },

      { at:"2026-01-21T14:33:00+09:00", siteName:"ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName:"éˆ´æœ¨", workAgain:"ã„ã„ãˆ", comment:"æ”¾ç½®ã•ã‚ŒãŸã€‚èª°ã«ã‚‚èã‘ãªã„ã€‚" },
      { at:"2026-01-29T09:02:00+09:00", siteName:"ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName:"éˆ´æœ¨", workAgain:"ã„ã„ãˆ", comment:"ç„¡è¦–ã•ã‚ŒãŸã€‚ç›®ã‚’åˆã‚ã›ãªã„ã€‚" },

      { at:"2026-01-23T16:40:00+09:00", siteName:"æ¨ªæµœæ”¯åº—", leaderName:"å±±æœ¬", workAgain:"ã¯ã„",   comment:"ä¸å¯§ã«æ•™ãˆã¦ãã‚ŒãŸã€‚" },
      { at:"2026-01-30T17:10:00+09:00", siteName:"æ¨ªæµœæ”¯åº—", leaderName:"å±±æœ¬", workAgain:"ä¸æ˜",  comment:"ç‰¹ã«ãªã—" },
    ];

    const NG_RULES = [
      { key:"æš´åŠ›/èº«ä½“", patterns:["è¹´ã‚‰ã‚Œ","å©ã‹ã‚Œ","æŠ¼ã•ã‚Œ","ç‰©ã‚’æŠ•ã’","æ®´"] },
      { key:"ç„¡è¦–/æ’é™¤", patterns:["ç„¡è¦–","æ”¾ç½®","ç›®ã‚’åˆã‚ã›","ä»²é–“å¤–ã‚Œ"] },
      { key:"æš´è¨€/å¨åœ§", patterns:["æ€’é³´","ç½µå€’","æ«å–","è©°ã‚ã‚‰ã‚Œ","æ€–ã‹ã£ãŸ"] },
    ];

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function normName(s){
      if (!s) return "";
      return String(s).trim().replace(/[ã€€\s]+/g,"").replace(/(ã•ã‚“|åº—é•·|ä¸»ä»»|ãƒªãƒ¼ãƒ€ãƒ¼)$/,"");
    }
    function detectNg(text){
      const t = (text || "").toString();
      const hits = [];
      for (const rule of NG_RULES){
        for (const p of rule.patterns){
          if (t.includes(p)){
            hits.push({ category: rule.key, pattern: p });
            break;
          }
        }
      }
      return hits;
    }
    function highlightEscaped(escapedText, hits){
      let out = escapedText;
      for (const h of hits){
        const p = escapeHtml(h.pattern);
        const idx = out.indexOf(p);
        if (idx >= 0){
          out = out.slice(0, idx) + "<mark>" + p + "</mark>" + out.slice(idx + p.length);
        }
      }
      return out;
    }
    function withinDays(atIso, days){
      const now = new Date("2026-02-01T00:00:00+09:00");
      const at = new Date(atIso);
      return (now - at) <= days * 24 * 60 * 60 * 1000;
    }

    let __improveLast = null;

    function buildImproveFiltered(){
      const days = Number(document.getElementById("impDaysSel").value || 30);
      const q = (document.getElementById("impQuery").value || "").trim();

      return improveRows
        .filter(r => withinDays(r.at, days))
        .filter(r => {
          if (!q) return true;
          const leader = normName(r.leaderName);
          return (r.siteName || "").includes(q) || (leader || "").includes(q) || (r.comment || "").includes(q);
        })
        .map(r => {
          const leaderNorm = normName(r.leaderName);
          const ngHits = detectNg(r.comment);
          const hasNg = ngHits.length > 0;
          return { ...r, leaderNorm, ngHits, hasNg };
        });
    }

    function leaderWorstSiteName(samples){
      const bySite = new Map();
      for (const s of samples){
        if (s.workAgain !== "ã¯ã„" && s.workAgain !== "ã„ã„ãˆ") continue;
        const site = s.siteName || "(ä¸æ˜)";
        if (!bySite.has(site)) bySite.set(site, { site, noCount:0, total:0 });
        const o = bySite.get(site);
        if (s.workAgain === "ã„ã„ãˆ") o.noCount++;
        o.total++;
      }
      let worst = null, worstRate = -1, worstN = -1;
      for (const o of bySite.values()){
        const rate = o.total ? (o.noCount / o.total) : 0;
        if (rate > worstRate || (rate === worstRate && o.total > worstN)){
          worstRate = rate; worstN = o.total; worst = o.site;
        }
      }
      return worst || "â€”";
    }

    function buildLeaderSiteRanks(enriched){
      const leaders = new Map();
      const sites = new Map();

      function bump(map, key, r){
        if (!map.has(key)) map.set(key, { key, noCount:0, totalKnown:0, ngCount:0, samples:[] });
        const o = map.get(key);
        if (r.workAgain === "ã¯ã„"){ o.totalKnown++; }
        if (r.workAgain === "ã„ã„ãˆ"){ o.noCount++; o.totalKnown++; }
        if (r.hasNg) o.ngCount += r.ngHits.length;
        o.samples.push(r);
      }

      for (const r of enriched){
        bump(leaders, r.leaderNorm || "(ä¸æ˜)", r);
        bump(sites, r.siteName || "(ä¸æ˜)", r);
      }

      const noRate = (o) => o.totalKnown ? (o.noCount / o.totalKnown) : -1;

      const leaderArr = [...leaders.values()]
        .map(o => ({...o, worstSiteName: leaderWorstSiteName(o.samples)}))
        .sort((a,b)=> (noRate(b)-noRate(a)) || (b.totalKnown-a.totalKnown) || (b.ngCount-a.ngCount));

      const siteArr = [...sites.values()]
        .sort((a,b)=> (b.noCount-a.noCount) || (b.totalKnown-a.totalKnown) || (noRate(b)-noRate(a)));

      return { leaderArr, siteArr };
    }

    function renderLeaderTable(rows){
      const el = document.getElementById("leaderTable");
      el.innerHTML = `
        <tr><th>ãƒªãƒ¼ãƒ€ãƒ¼åï¼ˆæ‹ ç‚¹åï¼‰</th><th>ã„ã„ãˆå›ç­”ç‡</th><th>å›ç­”æ•°</th></tr>
        ${rows.slice(0,10).map(r=>{
          const rate = r.totalKnown ? (r.noCount/r.totalKnown*100) : null;
          return `<tr>
            <td><strong>${escapeHtml(r.key)}</strong><span class="pill gray" style="margin-left:.5rem;">${escapeHtml(r.worstSiteName)}</span></td>
            <td>${rate===null?"â€”":rate.toFixed(0)+"%"}</td>
            <td>${r.totalKnown}</td>
          </tr>`;
        }).join("")}
      `;
    }

    function renderSiteTable(rows){
      const el = document.getElementById("siteTable");
      el.innerHTML = `
        <tr><th>æ‹ ç‚¹å</th><th>ã„ã„ãˆä»¶æ•°</th><th>ã„ã„ãˆå›ç­”ç‡</th><th>å›ç­”æ•°</th></tr>
        ${rows.slice(0,10).map(r=>{
          const rate = r.totalKnown ? (r.noCount/r.totalKnown*100) : null;
          return `<tr>
            <td><strong>${escapeHtml(r.key)}</strong></td>
            <td>${r.noCount}</td>
            <td>${rate===null?"â€”":rate.toFixed(0)+"%"}</td>
            <td>${r.totalKnown}</td>
          </tr>`;
        }).join("")}
      `;
    }

    function applyImprove(){
      const enriched = buildImproveFiltered();
      const ngAnswerCount = enriched.filter(r => r.hasNg).length;
      document.getElementById("kpiNg").textContent = ngAnswerCount;

      const { leaderArr, siteArr } = buildLeaderSiteRanks(enriched);
      renderLeaderTable(leaderArr);
      renderSiteTable(siteArr);

      __improveLast = { enriched };
      if (document.getElementById("ngPopover").classList.contains("active")) {
        renderNgPopover();
      }
    }

    function waPill(workAgain){
      if (workAgain === "ã„ã„ãˆ") return `<span class="pill badge-red">ã¾ãŸåƒããŸã„: ã„ã„ãˆ</span>`;
      if (workAgain === "ã¯ã„") return `<span class="pill badge-blue">ã¾ãŸåƒããŸã„: ã¯ã„</span>`;
      return `<span class="pill badge-amber">ã¾ãŸåƒããŸã„: ä¸æ˜</span>`;
    }

    function renderNgPopover(){
      const popBody = document.getElementById("popBody");
      const enriched = __improveLast?.enriched || [];
      const ngRows = enriched.filter(r => r.hasNg).slice(0,7);

      document.getElementById("popTitle").textContent = `NGãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ï¼ˆå›ç­”å˜ä½ï¼‰ ${ngRows.length}ä»¶`;

      popBody.innerHTML = ngRows.map(r => {
        const ngPills = r.ngHits.map(h => `<span class="pill gray">${escapeHtml(h.category)}:${escapeHtml(h.pattern)}</span>`).join(" ");
        return `
          <div class="ng-item">
            <div class="ng-meta">
              <span>${new Date(r.at).toLocaleString("ja-JP")}</span>
              <span>ğŸ“ <strong>${escapeHtml(r.siteName)}</strong></span>
              <span>ğŸ‘¤ <strong>${escapeHtml(r.leaderNorm || r.leaderName)}</strong></span>
              ${waPill(r.workAgain)}
              ${ngPills}
            </div>
            <div class="ng-text">${highlightEscaped(escapeHtml(r.comment), r.ngHits)}</div>
          </div>
        `;
      }).join("") || `<div class="muted">NGãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    }

    function placePopoverNear(anchorEl){
      const pop = document.getElementById("ngPopover");
      const container = document.querySelector("#improve .chart-container");
      const a = anchorEl.getBoundingClientRect();
      const c = container.getBoundingClientRect();

      let left = (a.left - c.left);
      let top  = (a.bottom - c.top) + 10;

      const maxLeft = container.clientWidth - pop.offsetWidth - 12;
      left = Math.max(12, Math.min(left, maxLeft));

      const maxTop = container.clientHeight - pop.offsetHeight - 12;
      if (top > maxTop) top = (a.top - c.top) - pop.offsetHeight - 10;
      top = Math.max(12, top);
      pop.style.left = left + "px";
      pop.style.top  = top + "px";
    }

    function toggleNgPopover(anchorEl){
      const pop = document.getElementById("ngPopover");
      if (pop.classList.contains("active")) { closePopover(); return; }
      renderNgPopover();
      pop.classList.add("active");
      requestAnimationFrame(() => placePopoverNear(anchorEl));
    }
    function closePopover(){ document.getElementById("ngPopover").classList.remove("active"); }

    /* =========================================================
      â‘¤ Talent tab (as-is)
    ========================================================= */
    function initTalentTab() {
      const HP_RULES = { minSessions: 11, minAvgRating: 4.0, cutRatingValue: 2, cutRatingCount: 2 };

      const leaderEvalMock = [
        { staffId: "A202601-0010", siteName: "é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ç”°ä¸­", rating: 5, good: "å£°ã‹ã‘ãŒä¸å¯§ã§å‘¨å›²ã®é›°å›²æ°—ãŒè‰¯ããªã‚‹", bad: "åˆå‹•ãŒå°‘ã—é…ã„æ—¥ãŒã‚ã£ãŸ" },
        { staffId: "A202601-0010", siteName: "é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ç”°ä¸­", rating: 4, good: "æ–°äººã¸ã®ãƒ•ã‚©ãƒ­ãƒ¼ãŒè‡ªç„¶", bad: "" },
        { staffId: "A202601-0010", siteName: "é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ä½è—¤", rating: 4, good: "å ±é€£ç›¸ãŒå®‰å®š", bad: "æ··é›‘æ™‚ã«å„ªå…ˆé †ä½ãŒã¶ã‚Œã‚‹" },
        { staffId: "A202601-0010", siteName: "é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ç”°ä¸­", rating: 5, good: "ãƒŸã‚¹ãŒå°‘ãªã„", bad: "" },
        { staffId: "A202601-0010", siteName: "é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ç”°ä¸­", rating: 4, good: "æ¥å®¢ãŒæ˜ã‚‹ã„", bad: "" },
        { staffId: "A202601-0010", siteName: "é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ä½è—¤", rating: 4, good: "é…åˆ»ãªã—ã§å®‰å®š", bad: "" },
        { staffId: "A202601-0010", siteName: "é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ç”°ä¸­", rating: 5, good: "å‘¨ã‚Šã‚’è¦‹ã¦å‹•ã‘ã‚‹", bad: "" },
        { staffId: "A202601-0010", siteName: "é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ç”°ä¸­", rating: 4, good: "æŒ‡ç¤ºã®ç†è§£ãŒæ—©ã„", bad: "" },
        { staffId: "A202601-0010", siteName: "é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ç”°ä¸­", rating: 4, good: "ä½œæ¥­ãŒæ­£ç¢º", bad: "" },
        { staffId: "A202601-0010", siteName: "é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ä½è—¤", rating: 5, good: "é¡§å®¢å¯¾å¿œãŒè‰¯ã„", bad: "" },
        { staffId: "A202601-0010", siteName: "é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ç”°ä¸­", rating: 4, good: "æ¸…æƒãŒä¸å¯§", bad: "" },

        { staffId: "A202601-0024", siteName: "ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "éˆ´æœ¨", rating: 4, good: "è½ã¡ç€ã„ã¦å¯¾å¿œã§ãã‚‹", bad: "" },
        { staffId: "A202601-0024", siteName: "ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "éˆ´æœ¨", rating: 5, good: "æ”¹å–„ææ¡ˆãŒå‡ºã‚‹", bad: "" },
        { staffId: "A202601-0024", siteName: "ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ä¼Šè—¤", rating: 4, good: "æ¬ å“¡å¯¾å¿œã«å¼·ã„", bad: "" },
        { staffId: "A202601-0024", siteName: "ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "éˆ´æœ¨", rating: 4, good: "æ–°äººè‚²æˆãŒä¸Šæ‰‹ã„", bad: "" },
        { staffId: "A202601-0024", siteName: "ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ä¼Šè—¤", rating: 4, good: "å ±é€£ç›¸ãŒçš„ç¢º", bad: "" },
        { staffId: "A202601-0024", siteName: "ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "éˆ´æœ¨", rating: 5, good: "é¡§å®¢ã‹ã‚‰ã®æŒ‡åãŒã‚ã£ãŸ", bad: "" },
        { staffId: "A202601-0024", siteName: "ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ä¼Šè—¤", rating: 4, good: "ä½œæ¥­ãŒæ—©ã„", bad: "" },
        { staffId: "A202601-0024", siteName: "ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "éˆ´æœ¨", rating: 4, good: "ãƒãƒ¼ãƒ ã«å‰å‘ã", bad: "" },
        { staffId: "A202601-0024", siteName: "ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "éˆ´æœ¨", rating: 4, good: "å®‰å®šç¨¼åƒ", bad: "" },
        { staffId: "A202601-0024", siteName: "ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ä¼Šè—¤", rating: 4, good: "ãƒŸã‚¹ãŒå°‘ãªã„", bad: "" },
        { staffId: "A202601-0024", siteName: "ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "éˆ´æœ¨", rating: 4, good: "æ°—é…ã‚ŠãŒè‰¯ã„", bad: "" },
        { staffId: "A202601-0024", siteName: "ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ä¼Šè—¤", rating: 5, good: "ç¹å¿™å¯¾å¿œãŒè‰¯ã„", bad: "" },

        { staffId: "A202601-0099", siteName: "å¤§é€šå…¬åœ’ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "æ¸¡è¾º", rating: 5, good: "ç«‹ã¡å›ã‚ŠãŒæ—©ã„", bad: "" },
        { staffId: "A202601-0099", siteName: "å¤§é€šå…¬åœ’ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "æ¸¡è¾º", rating: 4, good: "å ±é€£ç›¸ãŒä¸å¯§", bad: "" },
        { staffId: "A202601-0099", siteName: "å¤§é€šå…¬åœ’ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ä¼Šè—¤", rating: 4, good: "æ–°äººã®ãƒ•ã‚©ãƒ­ãƒ¼ãŒè‡ªç„¶", bad: "" },
        { staffId: "A202601-0099", siteName: "å¤§é€šå…¬åœ’ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "æ¸¡è¾º", rating: 5, good: "ãƒŸã‚¹ãŒå°‘ãªã„", bad: "" },
        { staffId: "A202601-0099", siteName: "å¤§é€šå…¬åœ’ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "æ¸¡è¾º", rating: 4, good: "æ™‚é–“ç®¡ç†ãŒä¸Šæ‰‹ã„", bad: "" },
        { staffId: "A202601-0099", siteName: "å¤§é€šå…¬åœ’ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ä¼Šè—¤", rating: 4, good: "ä¸å¯§ãªæ¥å®¢", bad: "" },
        { staffId: "A202601-0099", siteName: "å¤§é€šå…¬åœ’ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "æ¸¡è¾º", rating: 5, good: "å‘¨å›²ã‚’è¦‹ã¦å‹•ã‘ã‚‹", bad: "" },
        { staffId: "A202601-0099", siteName: "å¤§é€šå…¬åœ’ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "æ¸¡è¾º", rating: 4, good: "æ‰‹é †ç†è§£ãŒæ—©ã„", bad: "" },
        { staffId: "A202601-0099", siteName: "å¤§é€šå…¬åœ’ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "ä¼Šè—¤", rating: 4, good: "å®‰å®šç¨¼åƒ", bad: "" },
        { staffId: "A202601-0099", siteName: "å¤§é€šå…¬åœ’ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "æ¸¡è¾º", rating: 5, good: "æ”¹å–„ææ¡ˆãŒå‡ºã‚‹", bad: "" },
        { staffId: "A202601-0099", siteName: "å¤§é€šå…¬åœ’ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "æ¸¡è¾º", rating: 4, good: "é…åˆ»ãªã—", bad: "" },

        { staffId: "A202601-0111", siteName: "æ–°æ¨ªæµœæ”¯åº—", leaderName: "é«˜æ©‹", rating: 5, good: "é›°å›²æ°—ã¥ãã‚ŠãŒä¸Šæ‰‹ã„", bad: "" },
        { staffId: "A202601-0111", siteName: "æ–°æ¨ªæµœæ”¯åº—", leaderName: "é«˜æ©‹", rating: 4, good: "æŒ‡ç¤ºç†è§£ãŒæ—©ã„", bad: "" },
        { staffId: "A202601-0111", siteName: "æ–°æ¨ªæµœæ”¯åº—", leaderName: "å°æ—", rating: 4, good: "ä¸å¯§ãªä½œæ¥­", bad: "" },
        { staffId: "A202601-0111", siteName: "æ–°æ¨ªæµœæ”¯åº—", leaderName: "é«˜æ©‹", rating: 5, good: "ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œãŒè½ã¡ç€ã„ã¦ã„ã‚‹", bad: "" },
        { staffId: "A202601-0111", siteName: "æ–°æ¨ªæµœæ”¯åº—", leaderName: "é«˜æ©‹", rating: 4, good: "å‘¨å›²ã¸ã®å£°ã‹ã‘", bad: "" },
        { staffId: "A202601-0111", siteName: "æ–°æ¨ªæµœæ”¯åº—", leaderName: "å°æ—", rating: 4, good: "é…åˆ»ãªã—", bad: "" },
        { staffId: "A202601-0111", siteName: "æ–°æ¨ªæµœæ”¯åº—", leaderName: "é«˜æ©‹", rating: 5, good: "ç¹å¿™æ™‚ã®å„ªå…ˆé †ä½ãŒè‰¯ã„", bad: "" },
        { staffId: "A202601-0111", siteName: "æ–°æ¨ªæµœæ”¯åº—", leaderName: "é«˜æ©‹", rating: 4, good: "å ±é€£ç›¸ãŒæ˜ç¢º", bad: "" },
        { staffId: "A202601-0111", siteName: "æ–°æ¨ªæµœæ”¯åº—", leaderName: "å°æ—", rating: 4, good: "ãƒŸã‚¹ãŒå°‘ãªã„", bad: "" },
        { staffId: "A202601-0111", siteName: "æ–°æ¨ªæµœæ”¯åº—", leaderName: "é«˜æ©‹", rating: 5, good: "ä»–è€…ãƒ•ã‚©ãƒ­ãƒ¼ãŒã§ãã‚‹", bad: "" },
        { staffId: "A202601-0111", siteName: "æ–°æ¨ªæµœæ”¯åº—", leaderName: "é«˜æ©‹", rating: 4, good: "ç¶™ç¶šæ„æ¬²ãŒé«˜ã„", bad: "" },

        { staffId: "A202601-0150", siteName: "å…«ç‹å­æ”¯åº—", leaderName: "å±±æœ¬", rating: 5, good: "æŒ‡ç¤ºç†è§£ãŒæ—©ã„", bad: "" },
        { staffId: "A202601-0150", siteName: "å…«ç‹å­æ”¯åº—", leaderName: "å±±æœ¬", rating: 4, good: "å…ƒæ°—ã«æŒ¨æ‹¶ã§ãã‚‹", bad: "" },
        { staffId: "A202601-0150", siteName: "å…«ç‹å­æ”¯åº—", leaderName: "å±±æœ¬", rating: 4, good: "ä¸å¯§ãªä½œæ¥­", bad: "" },
        { staffId: "A202601-0150", siteName: "å…«ç‹å­æ”¯åº—", leaderName: "å±±æœ¬", rating: 4, good: "ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯è‰¯ã„", bad: "ç·Šå¼µã§å£°ãŒå°ã•ã„" },
        { staffId: "A202601-0150", siteName: "å…«ç‹å­æ”¯åº—", leaderName: "å±±æœ¬", rating: 5, good: "æ”¹å–„ææ¡ˆãŒå‡ºã‚‹", bad: "" },
        { staffId: "A202601-0150", siteName: "å…«ç‹å­æ”¯åº—", leaderName: "å±±æœ¬", rating: 4, good: "é…åˆ»ãªã—", bad: "" },
        { staffId: "A202601-0150", siteName: "å…«ç‹å­æ”¯åº—", leaderName: "å±±æœ¬", rating: 4, good: "ãŠå®¢æ§˜å¯¾å¿œãŒä¸å¯§", bad: "" },
        { staffId: "A202601-0150", siteName: "å…«ç‹å­æ”¯åº—", leaderName: "å±±æœ¬", rating: 4, good: "å¾Œç‰‡ä»˜ã‘ãŒæ—©ã„", bad: "" },
        { staffId: "A202601-0150", siteName: "å…«ç‹å­æ”¯åº—", leaderName: "å±±æœ¬", rating: 4, good: "å®‰å®šã—ã¦ã„ã‚‹", bad: "" },
        { staffId: "A202601-0150", siteName: "å…«ç‹å­æ”¯åº—", leaderName: "å±±æœ¬", rating: 4, good: "å ±é€£ç›¸ãŒè‰¯ã„", bad: "" },

        { staffId: "A202601-0777", siteName: "æ–°å®¿æ”¯åº—", leaderName: "å°æ—", rating: 4, good: "åŸºæœ¬ãŒä¸å¯§", bad: "" },
        { staffId: "A202601-0777", siteName: "æ–°å®¿æ”¯åº—", leaderName: "å°æ—", rating: 4, good: "å ±é€£ç›¸ã¯å®‰å®š", bad: "" },
        { staffId: "A202601-0777", siteName: "æ–°å®¿æ”¯åº—", leaderName: "å°æ—", rating: 4, good: "ä½œæ¥­é€Ÿåº¦ã¯ååˆ†", bad: "ãƒ”ãƒ¼ã‚¯æ™‚ã«ç„¦ã‚ŠãŒå‡ºã‚‹" },
        { staffId: "A202601-0777", siteName: "æ–°å®¿æ”¯åº—", leaderName: "å°æ—", rating: 4, good: "æ°—é…ã‚ŠãŒã‚ã‚‹", bad: "" },
        { staffId: "A202601-0777", siteName: "æ–°å®¿æ”¯åº—", leaderName: "å°æ—", rating: 3, good: "æ”¹å–„æ„æ¬²ã‚ã‚Š", bad: "å„ªå…ˆé †ä½ãŒã¶ã‚Œã‚‹" },
        { staffId: "A202601-0777", siteName: "æ–°å®¿æ”¯åº—", leaderName: "å°æ—", rating: 4, good: "é…åˆ»ãªã—", bad: "" },
        { staffId: "A202601-0777", siteName: "æ–°å®¿æ”¯åº—", leaderName: "å°æ—", rating: 4, good: "ç¶™ç¶šã—ã¦ã„ã‚‹", bad: "" },
        { staffId: "A202601-0777", siteName: "æ–°å®¿æ”¯åº—", leaderName: "å°æ—", rating: 4, good: "å‘¨å›²ã¨é€£æºã§ãã‚‹", bad: "" },
        { staffId: "A202601-0777", siteName: "æ–°å®¿æ”¯åº—", leaderName: "å°æ—", rating: 4, good: "æ³¨æ„ç‚¹ã®å¸åãŒæ—©ã„", bad: "" },
        { staffId: "A202601-0777", siteName: "æ–°å®¿æ”¯åº—", leaderName: "å°æ—", rating: 3, good: "å°‘ã—ãšã¤å®‰å®š", bad: "åˆå‹•ãŒé…ã‚Œã‚‹æ—¥ãŒã‚ã‚‹" },
        { staffId: "A202601-0777", siteName: "æ–°å®¿æ”¯åº—", leaderName: "å°æ—", rating: 4, good: "åŸºæœ¬ã¯å®‰å®š", bad: "" },

        { staffId: "A202601-0303", siteName: "åƒè‘‰æ”¯åº—", leaderName: "ä½è—¤", rating: 5, good: "æ˜ã‚‹ã„æ¥å®¢", bad: "" },
        { staffId: "A202601-0303", siteName: "åƒè‘‰æ”¯åº—", leaderName: "ä½è—¤", rating: 4, good: "æ‰‹é †ç†è§£ãŒæ—©ã„", bad: "" },
        { staffId: "A202601-0303", siteName: "åƒè‘‰æ”¯åº—", leaderName: "ä¼Šè—¤", rating: 4, good: "å ±é€£ç›¸ãŒä¸å¯§", bad: "" },
        { staffId: "A202601-0303", siteName: "åƒè‘‰æ”¯åº—", leaderName: "ä½è—¤", rating: 4, good: "é…åˆ»ãªã—", bad: "" },
        { staffId: "A202601-0303", siteName: "åƒè‘‰æ”¯åº—", leaderName: "ä½è—¤", rating: 5, good: "å‘¨å›²ã‚’è¦‹ã¦å‹•ã‘ã‚‹", bad: "" },
        { staffId: "A202601-0303", siteName: "åƒè‘‰æ”¯åº—", leaderName: "ä¼Šè—¤", rating: 4, good: "ä¸å¯§ãªä½œæ¥­", bad: "" },
        { staffId: "A202601-0303", siteName: "åƒè‘‰æ”¯åº—", leaderName: "ä½è—¤", rating: 4, good: "å®‰å®šç¨¼åƒ", bad: "" },
        { staffId: "A202601-0303", siteName: "åƒè‘‰æ”¯åº—", leaderName: "ä½è—¤", rating: 4, good: "åˆå‹•ãŒæ—©ã„", bad: "" },
        { staffId: "A202601-0303", siteName: "åƒè‘‰æ”¯åº—", leaderName: "ä¼Šè—¤", rating: 4, good: "æ”¹å–„ææ¡ˆãŒå‡ºã‚„ã™ã„", bad: "" },

        { staffId: "A202601-0444", siteName: "ä¸–ç”°è°·æ”¯åº—", leaderName: "æµ·é‡", rating: 4, good: "åŸºæœ¬ã¯å®‰å®š", bad: "" },
        { staffId: "A202601-0444", siteName: "ä¸–ç”°è°·æ”¯åº—", leaderName: "æµ·é‡", rating: 3, good: "æ”¹å–„æ„æ¬²ã‚ã‚Š", bad: "å„ªå…ˆé †ä½ãŒã¶ã‚Œã‚‹" },
        { staffId: "A202601-0444", siteName: "ä¸–ç”°è°·æ”¯åº—", leaderName: "æµ·é‡", rating: 4, good: "å ±é€£ç›¸ã¯è‰¯ã„", bad: "" },
        { staffId: "A202601-0444", siteName: "ä¸–ç”°è°·æ”¯åº—", leaderName: "å°æ—", rating: 3, good: "ä¸å¯§", bad: "ãƒ”ãƒ¼ã‚¯æ™‚ã«ç„¦ã‚‹" },
        { staffId: "A202601-0444", siteName: "ä¸–ç”°è°·æ”¯åº—", leaderName: "æµ·é‡", rating: 4, good: "é…åˆ»ãªã—", bad: "" },
        { staffId: "A202601-0444", siteName: "ä¸–ç”°è°·æ”¯åº—", leaderName: "æµ·é‡", rating: 3, good: "ç¶™ç¶š", bad: "åˆå‹•ãŒé…ã‚Œã‚‹æ—¥ãŒã‚ã‚‹" },
        { staffId: "A202601-0444", siteName: "ä¸–ç”°è°·æ”¯åº—", leaderName: "å°æ—", rating: 4, good: "é€£æºã§ãã‚‹", bad: "" },
        { staffId: "A202601-0444", siteName: "ä¸–ç”°è°·æ”¯åº—", leaderName: "æµ·é‡", rating: 3, good: "å°‘ã—ãšã¤å®‰å®š", bad: "" },
        { staffId: "A202601-0444", siteName: "ä¸–ç”°è°·æ”¯åº—", leaderName: "æµ·é‡", rating: 4, good: "åŸºæœ¬ä½œæ¥­", bad: "" },
        { staffId: "A202601-0444", siteName: "ä¸–ç”°è°·æ”¯åº—", leaderName: "å°æ—", rating: 4, good: "æ°—é…ã‚Š", bad: "" },
        { staffId: "A202601-0444", siteName: "ä¸–ç”°è°·æ”¯åº—", leaderName: "æµ·é‡", rating: 3, good: "æ”¹å–„å‚¾å‘", bad: "" },

        { staffId: "A202601-2568", siteName: "å¤§æ©‹ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "åŠ è—¤", rating: 4, good: "æ™®æ®µã¯å•é¡Œãªã„", bad: "" },
        { staffId: "A202601-2568", siteName: "å¤§æ©‹ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "åŠ è—¤", rating: 2, good: "", bad: "é…åˆ»ãŒã‚ã£ãŸ" },
        { staffId: "A202601-2568", siteName: "å¤§æ©‹ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "åŠ è—¤", rating: 3, good: "æ”¹å–„å‚¾å‘", bad: "æŒ‡ç¤ºã®èãæ¼ã‚Œ" },
        { staffId: "A202601-2568", siteName: "å¤§æ©‹ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "åŠ è—¤", rating: 2, good: "", bad: "ç„¡æ–­ã§æŠœã‘ãŸ" },
        { staffId: "A202601-2568", siteName: "å¤§æ©‹ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", leaderName: "åŠ è—¤", rating: 4, good: "ãã®å¾Œã¯å›å¾©", bad: "" },
      ];

      function topKeywords(text, n = 4) {
        const stop = new Set(["ã‚ã‚‹","ãªã„","ã™ã‚‹","ã—ãŸ","ã—ã¦","ã§ã™","ã¾ã™","ã‚‚ã®","ã“ã¨","ãã‚Œ","ã“ã‚Œ","ãŸã‚","ã‚ˆã†","ãã®å¾Œ","æ™®æ®µ","æ—¥ãŒ"]);
        const tokens = (text || "")
          .replace(/[0-9a-zA-Z]/g, " ")
          .match(/[\p{Script=Han}\p{Script=Hiragana}\p{Script=Katakana}]{2,}/gu) || [];
        const freq = new Map();
        for (const t of tokens) {
          if (stop.has(t)) continue;
          freq.set(t, (freq.get(t) || 0) + 1);
        }
        return [...freq.entries()].sort((a, b) => b[1] - a[1]).slice(0, n).map(([w]) => w);
      }

      function aggregateTalentFromLeaderEvals(rows) {
        const byStaff = new Map();
        for (const r of rows) {
          const key = r.staffId;
          if (!byStaff.has(key)) {
            byStaff.set(key, { staffId: r.staffId, siteName: r.siteName, leaderNames: new Set(), ratings: [], goodComments: [], badComments: [] });
          }
          const s = byStaff.get(key);
          if (r.siteName) s.siteName = r.siteName;
          if (r.leaderName) s.leaderNames.add(r.leaderName);
          if (Number.isFinite(r.rating)) s.ratings.push(r.rating);
          if (r.good) s.goodComments.push(r.good);
          if (r.bad) s.badComments.push(r.bad);
        }

        const staffList = [];
        for (const s of byStaff.values()) {
          const sessions = s.ratings.length;
          const avg = sessions ? (s.ratings.reduce((a, b) => a + b, 0) / sessions) : null;
          const cutCount = s.ratings.filter(x => x === HP_RULES.cutRatingValue).length;

          const isCut = cutCount >= HP_RULES.cutRatingCount;
          const isHighPerformer = !isCut && sessions >= HP_RULES.minSessions && avg !== null && avg >= HP_RULES.minAvgRating;

          let almostReason = null;
          if (!isCut && !isHighPerformer) {
            if (avg !== null && avg >= HP_RULES.minAvgRating && sessions < HP_RULES.minSessions) almostReason = "å›æ•°ä¸è¶³";
            else if (sessions >= HP_RULES.minSessions && avg !== null && avg < HP_RULES.minAvgRating) almostReason = "ã‚¹ã‚³ã‚¢ä¸è¶³";
            else almostReason = "ãã®ä»–";
          }

          staffList.push({
            staffId: s.staffId, siteName: s.siteName, sessions, avgRating: avg, cut2Count: cutCount,
            leaders: [...s.leaderNames],
            goodTop: topKeywords(s.goodComments.join(" "), 4),
            badTop: topKeywords(s.badComments.join(" "), 4),
            isCut, isHighPerformer, almostReason
          });
        }

        const hp = staffList.filter(x => x.isHighPerformer).sort((a, b) => (b.avgRating - a.avgRating) || (b.sessions - a.sessions));
        const almost = staffList.filter(x => !x.isCut && !x.isHighPerformer).sort((a, b) => (b.avgRating - a.avgRating) || (b.sessions - a.sessions));
        return { hp, almost };
      }

      function renderTalentMock() {
        const { hp, almost } = aggregateTalentFromLeaderEvals(leaderEvalMock);

        document.getElementById("hpCount").textContent = hp.length;
        document.getElementById("almostCount").textContent = almost.length;

        document.getElementById("hpRuleTag").innerHTML = `
          <span class="keyword-tag">å‚åŠ å›æ•° â‰¥ ${HP_RULES.minSessions}</span>
          <span class="keyword-tag">å¹³å‡è©•ä¾¡ â‰¥ ${HP_RULES.minAvgRating}</span>
          <span class="keyword-tag">è©•ä¾¡2ãŒ${HP_RULES.cutRatingCount}å›ä»¥ä¸Šã¯é™¤å¤–</span>
        `;
        document.getElementById("almostTag").innerHTML = `
          <span class="keyword-tag">å›æ•°ä¸è¶³ / ã‚¹ã‚³ã‚¢ä¸è¶³ ã®å€™è£œ</span>
          <span class="keyword-tag">è‚²æˆã§HPåŒ–</span>
        `;

        const hpGrid = document.getElementById("hpGrid");
        const almostGrid = document.getElementById("almostGrid");
        hpGrid.innerHTML = "";
        almostGrid.innerHTML = "";

        const makeCard = (p, badgeText, badgeCss, subBadgeText = "") => {
          const div = document.createElement("div");
          div.className = "performer-card";
          const sub = subBadgeText
            ? `<div class="performer-badge" style="background: rgba(148,163,184,0.18); color:#e2e8f0; border:1px solid rgba(148,163,184,0.25); margin-left:.5rem; text-transform:none;">${escapeHtml(subBadgeText)}</div>`
            : "";
          div.innerHTML = `
            <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
              <div class="performer-badge" style="${badgeCss}">${escapeHtml(badgeText)}</div>
              ${sub}
            </div>
            <div class="performer-info" style="margin-top: .5rem;">
              <div class="performer-name">${escapeHtml(p.staffId)}</div>
              <div class="performer-detail">ğŸ“ ${escapeHtml(p.siteName)}</div>
              <div class="performer-detail">ğŸ“… å‚åŠ ï¼ˆè©•ä¾¡å›æ•°ï¼‰: ${p.sessions}å›</div>
              <div class="performer-detail">â­ å¹³å‡è©•ä¾¡: ${p.avgRating?.toFixed(2) ?? "â€”"}</div>
              <div class="performer-detail">ğŸ‘¤ è©•ä¾¡è€…: ${escapeHtml(p.leaders.join(" / ") || "â€”")}</div>
              <div class="performer-detail">âœ… è‰¯ã„ç‚¹: ${escapeHtml((p.goodTop && p.goodTop.length) ? p.goodTop.join(" / ") : "â€”")}</div>
              <div class="performer-detail">ğŸ›  æ‚ªã„ç‚¹: ${escapeHtml((p.badTop && p.badTop.length) ? p.badTop.join(" / ") : "â€”")}</div>
            </div>
          `;
          return div;
        };

        const hpTop4 = hp.slice(0, 4);
        const almostTop4 = almost.slice(0, 4);

        for (const p of hpTop4) {
          hpGrid.appendChild(makeCard(p, "ç¤¾å“¡å‹§èª˜å€™è£œ (High Performer)", "background: linear-gradient(135deg, #10b981 0%, #059669 100%);"));
        }
        for (const p of almostTop4) {
          const reason = p.almostReason ? `ç†ç”±: ${p.almostReason}` : "";
          almostGrid.appendChild(makeCard(p, "è‚²æˆ/è¦è¦³å¯Ÿ", "background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);", reason));
        }

        const actions = document.getElementById("hpActions");
        actions.innerHTML = "";
        const topHp = hpTop4.slice(0, 3);

        const lines = [
          `ç¤¾å“¡å‹§èª˜å€™è£œï¼ˆè¡¨ç¤º: ${hpTop4.length}å / å…¨ä½“: ${hp.length}åï¼‰ã¸ï¼šé¢è«‡æ‰“è¨ºãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é€ä»˜ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰`,
          `ä¸Šä½å€™è£œï¼ˆ${topHp.map(x => x.staffId).join(", ") || "â€”"}ï¼‰ã¯ã€Œè·ç¨®å¸Œæœ›/ç¨¼åƒå¸Œæœ›ã€ã‚’è¿½åŠ ãƒ’ã‚¢ãƒªãƒ³ã‚°`,
          `è‚²æˆ/è¦è¦³å¯Ÿï¼ˆè¡¨ç¤º: ${almostTop4.length}å / å…¨ä½“: ${almost.length}åï¼‰ã¯æœªé”ç†ç”±ï¼ˆå›æ•°/ã‚¹ã‚³ã‚¢ï¼‰ã«å¿œã˜ã¦ç›®æ¨™è¨­å®š`,
          `é‹ç”¨ææ¡ˆï¼šè©•ä¾¡ãŒ2ã®ã¨ãã¯ç†ç”±ã‚«ãƒ†ã‚´ãƒªã‚’å¿…é ˆå…¥åŠ›ã«ã™ã‚‹`
        ];
        for (const t of lines) {
          const li = document.createElement("li");
          li.textContent = t;
          actions.appendChild(li);
        }
      }

      renderTalentMock();
    }

    /* =========================================================
      â‘¡ Map + â‘  Overview shared model
    ========================================================= */
    const norm = (v) => String(v ?? "").trim();
    const isYes = (v) => norm(v) === "ã¯ã„";
    const isNo  = (v) => norm(v) === "ã„ã„ãˆ";
    const toNumberOrNull = (v) => {
      const s = norm(v);
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    };
    const fmtPct = (v) => v == null ? "â€”" : `${v.toFixed(1)}%`;
    const fmtNum = (v, d=2) => v == null ? "â€”" : v.toFixed(d);
    function calcRate(num, den) { return den ? (100 * num / den) : null; }
    function calcAvg(sum, cnt) { return cnt ? (sum / cnt) : null; }
    function pillHtml(text, cls) { return `<span class="pill ${cls}">${escapeHtml(text)}</span>`; }
    function labelForClass(cls) { return cls==="blue"?"é’":cls==="yellow"?"é»„":cls==="red"?"èµ¤":"â€”"; }

    const siteToPrefCode = new Map([
      ["å¤§é€šå…¬åœ’ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 1],["æœ­å¹Œæ”¯åº—", 1],["æ–°ã•ã£ã½ã‚ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 1],["æ¸…ç”°æ”¯åº—", 1],
      ["ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 4],["ä»™å°å—æ”¯åº—", 4],
      ["åœŸæµ¦ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 8],["ã¤ãã°æ”¯åº—", 8],
      ["å®‡éƒ½å®®ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 9],["æ ƒæœ¨æ”¯åº—", 9],
      ["å¤§å®®ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 11],["ã•ã„ãŸã¾æ”¯åº—", 11],["ç†Šè°·ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 11],["ç†Šè°·æ”¯åº—", 11],
      ["æ‰€æ²¢ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 11],["æ‰€æ²¢æ”¯åº—", 11],["å·è¶Šã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 11],["å·è¶Šæ”¯åº—", 11],
      ["èˆ¹æ©‹ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 12],["åƒè‘‰æ”¯åº—", 12],["æ´¥ç”°æ²¼ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 12],["å…«åƒä»£æ”¯åº—", 12],
      ["æŸã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 12],["æŸæ”¯åº—", 12],["æ–°æ¾æˆ¸ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 12],["æ¾æˆ¸æ”¯åº—", 12],
      ["åƒè‘‰ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 12],["åƒè‘‰å—æ”¯åº—", 12],
      ["æ–°å®¿ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["æ±äº¬åŒ—æ”¯åº—", 13],["æ± è¢‹ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["ç·´é¦¬æ”¯åº—", 13],
      ["èµ¤ç¾½ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["äº¬åŒ—æ”¯åº—", 13],["é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["æ–°å®¿æ”¯åº—", 13],
      ["ä¸‹åŒ—æ²¢ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["ä¸–ç”°è°·æ”¯åº—", 13],["ç«‹å·ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["å›½ç«‹æ”¯åº—", 13],
      ["å…«ç‹å­ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["å…«ç‹å­æ”¯åº—", 13],["å¤šæ‘©æ”¯åº—", 13],["æ‹å³¶ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],
      ["æ±å¤§å’Œæ”¯åº—", 13],["å‰ç¥¥å¯ºã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["è¥¿æ±äº¬æ”¯åº—", 13],["æ¸‹è°·ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],
      ["è‡ªç”±ãŒä¸˜ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["äº”åç”°ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["æ¸¯æ”¯åº—", 13],["è’²ç”°ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],
      ["æ±äº¬å—æ”¯åº—", 13],["ç›®é»’æ”¯åº—", 13],["éŒ¦ç³¸ç”ºã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["å¢¨ç”°æ”¯åº—", 13],
      ["ç§‹è‘‰åŸã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["æ±Ÿæ±æ”¯åº—", 13],["åŒ—åƒä½ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["è¶³ç«‹æ”¯åº—", 13],
      ["è‘›è¥¿ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],["è‘›è¥¿æ”¯åº—", 13],["ç”ºç”°ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 13],
      ["ç™»æˆ¸ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 14],["æ±äº¬æ”¯åº—", 14],["å·å´ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 14],["å·å´æ”¯åº—", 14],
      ["æºã®å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 14],["æ¨ªæµœæ”¯åº—", 14],["è—¤æ²¢ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 14],["æ¹˜å—æ”¯åº—", 14],
      ["åšæœ¨ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 14],["åšæœ¨æ”¯åº—", 14],["å¹³å¡šã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 14],["å°ç”°åŸæ”¯åº—", 14],
      ["ä¸Šå¤§å²¡ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 14],["æ¨ªæµœå—æ”¯åº—", 14],["æ¨ªæµœã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 14],["æ–°æ¨ªæµœæ”¯åº—", 14],
      ["æ¨ªæµœéƒ½ç­‘æ”¯åº—", 14],["æ¨ªé ˆè³€ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 14],["æ¨ªé ˆè³€æ”¯åº—", 14],
      ["é‡‘æ²¢é¼“é–€ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 17],["é‡‘æ²¢æ”¯åº—", 17],
      ["é™å²¡ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 22],["é™å²¡æ”¯åº—", 22],["æµœæ¾ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 22],["æµœæ¾æ”¯åº—", 22],
      ["åé§…ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 23],["åå¤å±‹æ”¯åº—", 23],["å¤§æ›½æ ¹ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 23],["åæ±æ”¯åº—", 23],
      ["å¤©ç™½æ”¯åº—", 23],["ä¸€å®®ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 23],["åŒ—åå¤å±‹æ”¯åº—", 23],
      ["äº¬éƒ½é§…å‰ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 26],["äº¬éƒ½åŒ—æ”¯åº—", 26],
      ["äº¬æ©‹ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 27],["å¤§é˜ªä¸­å¤®æ”¯åº—", 27],["é›£æ³¢ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 27],["è¥¿å¤§é˜ªæ”¯åº—", 27],
      ["åŒ—å¤§é˜ªæ”¯åº—", 27],["åä¸‰ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 27],["å¤§é˜ªæ”¯åº—", 27],["æ¢…ç”°ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 27],["å¹ç”°æ”¯åº—", 27],
      ["ä¼Šä¸¹ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 28],["ä¸‰å®®ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 28],["ç¥æˆ¸æ±æ”¯åº—", 28],["ç¥æˆ¸æ”¯åº—", 28],
      ["è¥¿å®®åŒ—å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 28],["è¥¿å®®æ”¯åº—", 28],["å§«è·¯ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 28],["å§«è·¯æ”¯åº—", 28],
      ["åºƒå³¶é§…å‰ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 34],["åºƒå³¶å—æ”¯åº—", 34],
      ["ç“¦ç”ºã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 37],["é«˜æ¾æ”¯åº—", 37],
      ["ç¦å²¡ä¸­å¤®ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 40],["ç¦å²¡æ”¯åº—", 40],["å¤§æ©‹ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚»ãƒ³ã‚¿ãƒ¼", 40],["ç¦å²¡å—æ”¯åº—", 40],
    ]);

    const metricDefs = {
      next: { label: "äºˆç´„ç‡", prefValue: (p) => p.nextReservationRate, format: (v) => v == null ? "â€”" : `${v.toFixed(1)}%`,
        color: (v) => (v == null) ? "#475569" : (v >= 80 ? "#3b82f6" : v >= 60 ? "#f59e0b" : "#ef4444") },
      sat:  { label: "æº€è¶³åº¦", prefValue: (p) => p.satisfactionAvg, format: (v) => v == null ? "â€”" : v.toFixed(2),
        color: (v) => (v == null) ? "#475569" : (v >= 4 ? "#3b82f6" : v >= 3 ? "#f59e0b" : "#ef4444") },
      greet:{ label: "æŒ¨æ‹¶ï¼ˆãªã—ç‡ï¼‰", prefValue: (p) => p.noGreetingRate, format: (v) => v == null ? "â€”" : `${v.toFixed(1)}%`,
        color: (v) => (v == null) ? "#475569" : (v >= 50 ? "#ef4444" : v >= 20 ? "#f59e0b" : "#3b82f6") }
    };

    function classForMetric(metricKey, obj) {
      if (!obj) return "gray";
      if (metricKey === "next") { const v=obj.nextReservationRate; if (v==null) return "gray"; return v>=80?"blue":v>=60?"yellow":"red"; }
      if (metricKey === "sat")  { const v=obj.satisfactionAvg; if (v==null) return "gray"; return v>=4?"blue":v>=3?"yellow":"red"; }
      if (metricKey === "greet"){ const v=obj.noGreetingRate; if (v==null) return "gray"; return v>=50?"red":v>=20?"yellow":"blue"; }
      return "gray";
    }
    function overallClassForSite(siteObj) {
      const c1 = classForMetric("next", siteObj);
      const c2 = classForMetric("sat", siteObj);
      const c3 = classForMetric("greet", siteObj);
      if ([c1,c2,c3].includes("red")) return "red";
      if ([c1,c2,c3].includes("yellow")) return "yellow";
      if ([c1,c2,c3].includes("blue")) return "blue";
      return "gray";
    }

    function parseTable(text) {
      const raw = (text ?? "").replace(/\r\n/g, "\n").replace(/\r/g, "\n").trim();
      if (!raw) return [];
      const firstLine = raw.split("\n")[0] ?? "";
      const delim = firstLine.includes("\t") ? "\t" : (firstLine.includes(",") ? "," : "\t");
      const lines = raw.split("\n").filter(l => l.trim().length > 0);
      if (lines.length < 2) return [];
      const header = lines[0].split(delim).map(h => h.replace(/\uFEFF/g,"").trim());
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(delim);
        const obj = {};
        for (let j = 0; j < header.length; j++) obj[header[j]] = (cols[j] ?? "");
        rows.push(obj);
      }
      return rows;
    }
    function getCol(row, names) {
      for (const name of names) {
        if (row[name] != null && String(row[name]).trim() !== "") return row[name];
      }
      for (const name of names) if (row[name] != null) return row[name];
      return "";
    }
    function normJP(v) {
      return String(v ?? "")
        .trim()
        .replace(/[ ã€€]+/g, "")
        .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
    }
    function parseReserveAnswer(raw) {
      const s = normJP(raw);
      if (!s) return { kind: "empty" };
      const yes = ["ã„ã‚ŒãŸ","å…¥ã‚ŒãŸ","äºˆç´„ã—ãŸ","äºˆç´„å…¥ã‚ŒãŸ","äºˆç´„ã„ã‚ŒãŸ","å…¥ã‚Œã‚‹","å…¥ã‚Œã¾ã™","ã¯ã„","æœ‰","ã‚ã‚Š","ã™ã‚‹","æ¸ˆ"];
      const no  = ["ã„ã‚Œãªã„","å…¥ã‚Œãªã„","äºˆç´„ã—ãªã„","äºˆç´„ãªã—","ã„ã„ãˆ","ç„¡","ãªã—","ã—ãªã„","æœª"];
      if (yes.some(w => s.includes(w))) return { kind: "yes" };
      if (no.some(w => s.includes(w))) return { kind: "no" };
      return { kind: "unknown" };
    }

    function aggregateSites(rows1_5, rows6_10) {
      const bySite = new Map();
      const get = (siteName) => {
        if (!bySite.has(siteName)) {
          bySite.set(siteName, { siteName, next_num:0, next_den:0, sat_sum:0, sat_cnt:0, greet_no:0, greet_den:0 });
        }
        return bySite.get(siteName);
      };

      for (const r of rows1_5) {
        const site = norm(getCol(r, ["å‹¤å‹™å…ˆ","æ‹ ç‚¹","æ”¯åº—","åº—èˆ—","åº—","å‹¤å‹™åœ°"]));
        if (!site) continue;
        const a = get(site);

        const parsed = parseReserveAnswer(r["æ¬¡ã®äºˆç´„"]);
        if (parsed.kind === "yes") { a.next_den++; a.next_num++; }
        else if (parsed.kind === "no") { a.next_den++; }

        const sat = toNumberOrNull(getCol(r, ["æº€è¶³åº¦","æº€è¶³","æº€è¶³åº¦ï¼ˆ5æ®µéšï¼‰"]));
        if (sat != null) { a.sat_sum += sat; a.sat_cnt++; }

        const introRaw = getCol(r, ["ãƒªãƒ¼ãƒ€ãƒ¼ã‹ã‚‰ã®è‡ªå·±ç´¹ä»‹","è‡ªå·±ç´¹ä»‹"]);
        const intro = norm(introRaw);
        if (isYes(intro) || isNo(intro)) { a.greet_den++; if (isNo(intro)) a.greet_no++; }
      }

      for (const r of rows6_10) {
        const site = norm(getCol(r, ["å‹¤å‹™å…ˆ","æ‹ ç‚¹","æ”¯åº—","åº—èˆ—","åº—","å‹¤å‹™åœ°"]));
        if (!site) continue;
        const a = get(site);

        const sat = toNumberOrNull(getCol(r, ["æº€è¶³åº¦","æº€è¶³","æº€è¶³åº¦ï¼ˆ5æ®µéšï¼‰"]));
        if (sat != null) { a.sat_sum += sat; a.sat_cnt++; }

        const introRaw = getCol(r, ["ãƒªãƒ¼ãƒ€ãƒ¼ã‹ã‚‰ã®è‡ªå·±ç´¹ä»‹","è‡ªå·±ç´¹ä»‹"]);
        const intro = norm(introRaw);
        if (isYes(intro) || isNo(intro)) { a.greet_den++; if (isNo(intro)) a.greet_no++; }
      }

      return bySite;
    }

    function buildPrefView(bySite) {
      const byPref = new Map();
      const unknownSites = [];
      const getPref = (prefCode) => {
        if (!byPref.has(prefCode)) {
          byPref.set(prefCode, { prefCode, next_num:0, next_den:0, sat_sum:0, sat_cnt:0, greet_no:0, greet_den:0, sites:[] });
        }
        return byPref.get(prefCode);
      };

      for (const a of bySite.values()) {
        const prefCode = siteToPrefCode.get(a.siteName);
        if (!prefCode) { unknownSites.push(a.siteName); continue; }
        const p = getPref(prefCode);

        p.next_num += a.next_num; p.next_den += a.next_den;
        p.sat_sum  += a.sat_sum;  p.sat_cnt  += a.sat_cnt;
        p.greet_no += a.greet_no; p.greet_den += a.greet_den;

        p.sites.push({
          siteName: a.siteName,
          prefCode,
          next_num: a.next_num, next_den: a.next_den,
          sat_sum: a.sat_sum,   sat_cnt: a.sat_cnt,
          greet_no: a.greet_no, greet_den: a.greet_den,
          nextReservationRate: calcRate(a.next_num, a.next_den),
          satisfactionAvg: calcAvg(a.sat_sum, a.sat_cnt),
          noGreetingRate: calcRate(a.greet_no, a.greet_den),
        });
      }

      for (const p of byPref.values()) {
        p.nextReservationRate = calcRate(p.next_num, p.next_den);
        p.satisfactionAvg = calcAvg(p.sat_sum, p.sat_cnt);
        p.noGreetingRate = calcRate(p.greet_no, p.greet_den);
        p.sites.sort((x,y)=> (y.sat_cnt+y.greet_den+y.next_den)-(x.sat_cnt+x.greet_den+x.next_den));
      }
      return { byPref, unknownSites };
    }

    let svgRoot2 = null;
    let currentMetricKey2 = "next";
    let currentMonthMode2 = "curr";
    let statePrev2 = { byPref: new Map(), unknownSites: [] };
    let stateCurr2 = { byPref: new Map(), unknownSites: [] };
    let lastPrefPopupContext2 = null;
    let activeSiteKey2 = null;

    async function loadJapanSvg2(url = "./japan.svg") {
      const container = document.getElementById("mapContainer2");
      const status = document.getElementById("mapStatus2");
      status.textContent = "åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦";
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) {
        status.textContent = `åœ°å›³SVGã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${res.status}`;
        throw new Error(`fetch failed: ${res.status}`);
      }
      const svgText = await res.text();
      container.insertAdjacentHTML("afterbegin", svgText);

      const svg = container.querySelector("svg.geolonia-svg-map") || container.querySelector("svg");
      if (!svg) throw new Error("SVG element not found");
      svg.style.width = "100%";
      svg.style.height = "100%";
      try { svg.setAttribute("viewBox", "80 40 860 860"); } catch(e) {}
      const n = svg.querySelectorAll(".prefecture").length;
      status.textContent = `åœ°å›³èª­ã¿è¾¼ã¿OKï¼ˆprefectureæ•°: ${n}ï¼‰`;
      return svg;
    }

    function getActiveState2() {
      const st = currentMonthMode2 === "prev" ? statePrev2 : stateCurr2;
      return { byPref: st.byPref, metricKey: currentMetricKey2, monthLabel: currentMonthMode2==="prev" ? "å…ˆæœˆ" : "ä»Šæœˆ" };
    }

    function paintMap2(svg, byPref, metricKey) {
      const def = metricDefs[metricKey];
      svg.querySelectorAll(".prefecture").forEach(el => {
        const prefCode = Number(el.getAttribute("data-code"));
        const pref = byPref.get(prefCode);
        const v = pref ? def.prefValue(pref) : null;
        el.style.fill = def.color(v);
      });
    }

    function hidePrefPopup2() { document.getElementById("prefPopup2").style.display = "none"; }

    function showPrefPopup2({ prefEl, prefCode, prefAgg, metricKey, monthLabel, anchorEvent }) {
      const popup = document.getElementById("prefPopup2");
      const titleEl = document.getElementById("prefPopupTitle2");
      const metaEl  = document.getElementById("prefPopupMeta2");
      const sitesEl = document.getElementById("prefPopupSites2");
      const moreEl  = document.getElementById("prefPopupMore2");

      const rawTitle = prefEl.querySelector("title")?.textContent?.trim() || `éƒ½é“åºœçœŒ ${prefCode}`;
      const prefName = rawTitle.split("/")[0].trim();
      titleEl.textContent = `${monthLabel}ï¼š${prefName}`;

      const pillCls = classForMetric(metricKey, prefAgg);
      metaEl.innerHTML = `
        ${pillHtml(labelForClass(pillCls), pillCls)}
        <span class="muted">äºˆç´„ç‡</span>ï¼š<b>${fmtPct(prefAgg?.nextReservationRate)}</b>
        <span class="muted">æ‹ ç‚¹æ•°</span>ï¼š<b>${prefAgg?.sites?.length ?? 0}</b>
        <span class="muted">æº€è¶³</span>ï¼š<b>${fmtNum(prefAgg?.satisfactionAvg,2)}</b>
        <span class="muted">æŒ¨æ‹¶ãªã—</span>ï¼š<b>${fmtPct(prefAgg?.noGreetingRate)}</b>
      `;

      const sites = (prefAgg?.sites ?? []).slice()
        .sort((a,b)=> (b.sat_cnt+b.greet_den+b.next_den)-(a.sat_cnt+a.greet_den+a.next_den));
      const top = sites.slice(0, 10);

      if (top.length === 0) {
        sitesEl.innerHTML = `<div class="muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      } else {
        sitesEl.innerHTML = top.map(s => {
          const clsOverall = overallClassForSite(s);
          return `
            <button class="popupSiteBtn" type="button" data-site="${escapeHtml(s.siteName)}" data-pref="${prefCode}">
              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <div style="font-weight:900;">${escapeHtml(s.siteName)}</div>
                ${pillHtml(labelForClass(clsOverall), clsOverall)}
              </div>
              <div style="color:#cbd5e1;font-size:12px;margin-top:4px;">
                äºˆç´„: ${fmtPct(s.nextReservationRate)}ï¼ˆå›ç­”æ•°=${s.next_den}ï¼‰ /
                æº€è¶³: ${fmtNum(s.satisfactionAvg,2)}ï¼ˆå›ç­”æ•°=${s.sat_cnt}ï¼‰ /
                æŒ¨æ‹¶ãªã—: ${fmtPct(s.noGreetingRate)}ï¼ˆå›ç­”æ•°=${s.greet_den}ï¼‰
              </div>
            </button>
          `;
        }).join("");
      }

      moreEl.textContent = sites.length > 10 ? `ä»– ${sites.length - 10} æ‹ ç‚¹â€¦ï¼ˆå…ˆé ­10ä»¶ã®ã¿è¡¨ç¤ºï¼‰` : "";

      const container = document.getElementById("mapContainer2");
      const rect = container.getBoundingClientRect();
      let x = rect.width * 0.5, y = rect.height * 0.3;
      if (anchorEvent?.clientX != null) { x = anchorEvent.clientX - rect.left; y = anchorEvent.clientY - rect.top; }

      popup.style.display = "block";
      popup.style.left = "0px"; popup.style.top = "0px";

      const pw = popup.offsetWidth, ph = popup.offsetHeight;
      let left = x + 12, topPos = y + 12;
      if (left + pw > rect.width) left = Math.max(8, x - pw - 12);
      if (topPos + ph > rect.height) topPos = Math.max(8, y - ph - 12);
      popup.style.left = `${left}px`;
      popup.style.top  = `${topPos}px`;

      lastPrefPopupContext2 = { prefCode, anchor: anchorEvent ? { clientX: anchorEvent.clientX, clientY: anchorEvent.clientY } : null };
    }

    function openModal2() {
      const m = document.getElementById("siteDetailModal2");
      m.classList.add("is-open");
      m.setAttribute("aria-hidden", "false");
    }
    function closeModal2() {
      const m = document.getElementById("siteDetailModal2");
      m.classList.remove("is-open");
      m.setAttribute("aria-hidden", "true");
    }

    function buildAiMock2(site) {
      const issues = [], causes = [], actions = [], trends = [];
      if (site.nextReservationRate != null && site.nextReservationRate < 60) {
        issues.push("äºˆç´„ç‡ãŒä½ã„ï¼ˆ<60%ï¼‰");
        causes.push("åˆå›ä½“é¨“ã®æœŸå¾…å€¤èª¿æ•´ä¸è¶³ã€å½“æ—¥ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸è¶³ã®å¯èƒ½æ€§");
        actions.push("çµ‚äº†5åˆ†å‰ã®äºˆç´„ææ¡ˆãƒˆãƒ¼ã‚¯ã‚’æ¨™æº–åŒ–ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ï¼‹QRæ¡ˆå†…ï¼‰");
        actions.push("å½“æ—¥ä¸­ã«äºˆç´„ã§ãã‚‹å°ç·šï¼ˆæ è¦‹ãˆã‚‹åŒ–ï¼‰ã‚’å¼·åŒ–");
        trends.push("åˆå›å±¤ã®é›¢è„±ãŒèµ·ãã‚„ã™ã„æ§‹é€ ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§");
      } else if (site.nextReservationRate != null && site.nextReservationRate < 80) {
        issues.push("äºˆç´„ç‡ãŒä¸­ä½ï¼ˆ60ã€œ80%ï¼‰");
        causes.push("äºˆç´„å°ç·šã¯ã‚ã‚‹ãŒã€èƒŒä¸­æŠ¼ã—ãŒå¼±ã„å¯èƒ½æ€§");
        actions.push("ã€æ¬¡ã«æ¥ã‚‹ãƒ¡ãƒªãƒƒãƒˆã€ã‚’ä¸€è¨€ã§ä¼ãˆã‚‹é‹ç”¨ï¼ˆç¨¼ã/æ…£ã‚Œ/äººé–“é–¢ä¿‚ï¼‰");
        trends.push("é‹ç”¨æ”¹å–„ã§80%+ã«ä¸Šã’ã‚‰ã‚Œã‚‹ä½™åœ°");
      }
      if (site.satisfactionAvg != null && site.satisfactionAvg < 3) {
        issues.push("æº€è¶³åº¦ãŒä½ã„ï¼ˆ<3.0ï¼‰");
        causes.push("æŒ‡ç¤ºã®ä¸æ˜ç¢ºã•ã€ãƒ•ã‚©ãƒ­ãƒ¼ä¸è¶³ã€å‚™å“/ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ä¸æº€ãŒé¡•åœ¨åŒ–ã—ã¦ã„ã‚‹å¯èƒ½æ€§");
        actions.push("ä½œæ¥­é–‹å§‹å‰ã®5åˆ†ãƒ–ãƒªãƒ¼ãƒ•ã‚£ãƒ³ã‚°ï¼ˆæµã‚Œ/æ³¨æ„ç‚¹/è³ªç–‘ï¼‰ã‚’å¿…é ˆåŒ–");
        actions.push("ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ã®ãƒã‚§ãƒƒã‚¯ï¼†äº¤æ›ã‚µã‚¤ã‚¯ãƒ«ã®è¦‹ç›´ã—");
        trends.push("è‡ªç”±è¨˜è¿°ã«ä¸æº€ç³»ãƒ¯ãƒ¼ãƒ‰ãŒå¢—ãˆã‚‹å‚¾å‘");
      } else if (site.satisfactionAvg != null && site.satisfactionAvg < 4) {
        issues.push("æº€è¶³åº¦ãŒä¸­ä½ï¼ˆ3.0ã€œ4.0ï¼‰");
        causes.push("ä¸€å®šã®æº€è¶³ã¯ã‚ã‚‹ãŒã€ä½“é¨“ã®ãƒ ãƒ©ãŒæ®‹ã‚‹å¯èƒ½æ€§");
        actions.push("èª¬æ˜å“è³ªã‚’å‡ä¸€åŒ–ï¼ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé‹ç”¨ï¼‰");
        trends.push("æ”¹å–„è¦æœ›ã¯ã€é€£çµ¡ã€ã€æŒ‡ç¤ºã€ã«å¯„ã‚Šã‚„ã™ã„");
      }
      if (site.noGreetingRate != null && site.noGreetingRate >= 50) {
        issues.push("æŒ¨æ‹¶ï¼ˆè‡ªå·±ç´¹ä»‹ï¼‰æœªå®Ÿæ–½ç‡ãŒé«˜ã„ï¼ˆ>=50%ï¼‰");
        causes.push("å°å…¥ãŒçœç•¥ã•ã‚Œã¦ã„ã‚‹/å¤šå¿™/æ‰‹é †æœªæ•´å‚™ã®å¯èƒ½æ€§");
        actions.push("ã€è‡ªå·±ç´¹ä»‹â†’ä»Šæ—¥ã®æµã‚Œâ†’è³ªå•ã€ã®30ç§’å°ç·šã‚’æ¨™æº–åŒ–");
        actions.push("å°å…¥å®Ÿæ–½ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼‰");
        trends.push("æº€è¶³åº¦/äºˆç´„ç‡ã«ã‚‚æ³¢åŠã—ã‚„ã™ã„");
      } else if (site.noGreetingRate != null && site.noGreetingRate >= 20) {
        issues.push("æŒ¨æ‹¶æœªå®Ÿæ–½ç‡ãŒä¸­ä½ï¼ˆ20ã€œ50%ï¼‰");
        causes.push("ãƒ”ãƒ¼ã‚¯æ™‚ã«å°å…¥ãŒé£›ã³ã‚„ã™ã„é‹ç”¨ã®å¯èƒ½æ€§");
        actions.push("å¿™ã—ã„æ—¥ã»ã©å°å…¥ã‚’çŸ­ç¸®ã—ã¦ã‚‚å¿…ãšå®Ÿæ–½ï¼ˆ10ç§’ç‰ˆï¼‰");
        trends.push("æ™‚é–“å¸¯/æ‹…å½“è€…ã§åã‚ŠãŒå‡ºã‚„ã™ã„");
      }
      if (issues.length === 0) {
        issues.push("å¤§ããªèª²é¡Œã‚·ã‚°ãƒŠãƒ«ã¯å¼·ããªã„ï¼ˆæŒ‡æ¨™ä¸Šï¼‰");
        causes.push("ç¾çŠ¶ç¶­æŒã§ã‚‚è‰¯ã„ãŒã€é‹ç”¨æ¨™æº–åŒ–ã§å®‰å®šåŒ–ä½™åœ°");
        actions.push("è‰¯ã„é‹ç”¨ã‚’ä»–æ‹ ç‚¹ã«å±•é–‹ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åŒ–ï¼‰");
        trends.push("æ¯æ•°å¢—åŠ æ™‚ã«ãƒ–ãƒ¬ãŒè¦‹ãˆã‚‹å¯èƒ½æ€§");
      }
      return { issues, causes, actions, trends };
    }

    function renderSiteDetailModal2({ site, prefCode, monthLabel }) {
      activeSiteKey2 = site.siteName;
      document.getElementById("modalSubTitle2").textContent = `${monthLabel} / éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ ${prefCode} / ${site.siteName}`;

      const st = (currentMonthMode2 === "prev") ? statePrev2 : stateCurr2;
      const prefAgg = st.byPref.get(prefCode);
      const sites = prefAgg?.sites ?? [];

      const otherState = currentMonthMode2 === "prev" ? stateCurr2 : statePrev2;
      const otherPref = otherState.byPref.get(prefCode);
      const otherSite = otherPref?.sites?.find(s => s.siteName === site.siteName);

      function deltaPct(curr, prev) {
        if (curr == null || prev == null) return { text:"â€”", cls:"deltaFlat" };
        const d = clamp(curr - prev, -8, 8); // â˜…ä¿é™ºï¼šÎ”ã‚’-8ã€œ+8ptã«ã‚¯ãƒ©ãƒ³ãƒ—
        const cls = d > 0.0001 ? "deltaUp" : d < -0.0001 ? "deltaDown" : "deltaFlat";
        const sign = d > 0.0001 ? "+" : d < -0.0001 ? "" : "Â±";
        return { text: `${sign}${d.toFixed(1)}%`, cls };
      }
      function deltaNum(curr, prev) {
        if (curr == null || prev == null) return { text:"â€”", cls:"deltaFlat" };
        const dRaw = curr - prev;
        const d = clamp(dRaw, -0.8, 0.8); // â˜…æº€è¶³åº¦Î”ã¯Â±0.8ã«ä¿é™ºï¼ˆè¦ä»¶Î”Â±8ptã®è¶£æ—¨ã«åˆã‚ã›ãŸé‹ç”¨ï¼‰
        const cls = d > 0.0001 ? "deltaUp" : d < -0.0001 ? "deltaDown" : "deltaFlat";
        const sign = d > 0.0001 ? "+" : d < -0.0001 ? "" : "Â±";
        return { text: `${sign}${d.toFixed(2)}`, cls };
      }

      const dRes = deltaPct(site.nextReservationRate, otherSite?.nextReservationRate ?? null);
      const dNg  = deltaPct(site.noGreetingRate, otherSite?.noGreetingRate ?? null);
      const dSat = deltaNum(site.satisfactionAvg, otherSite?.satisfactionAvg ?? null);

      const ai = buildAiMock2(site);

      const body = document.getElementById("modalBody2");
      body.innerHTML = `
        <div class="selectBar">
          <div class="muted" style="font-weight:800;">æ‹ ç‚¹</div>
          <select id="siteSelect2"></select>
        </div>

        <div class="kpiGrid">
          <div class="kpiCard">
            <div class="kpiLabel">äºˆç´„ç‡ï¼ˆ1ã€œ5å›ç›®ï¼‰</div>
            <div class="kpiValue">${fmtPct(site.nextReservationRate)}</div>
            <div class="kpiDelta ${dRes.cls}">${dRes.text}</div>
            <div class="muted" style="margin-top:6px;font-size:12px;">å›ç­”æ•°=${site.next_den}</div>
          </div>
          <div class="kpiCard">
            <div class="kpiLabel">æŒ¨æ‹¶ãªã—ç‡</div>
            <div class="kpiValue">${fmtPct(site.noGreetingRate)}</div>
            <div class="kpiDelta ${dNg.cls}">${dNg.text}</div>
            <div class="muted" style="margin-top:6px;font-size:12px;">å›ç­”æ•°=${site.greet_den}</div>
          </div>
          <div class="kpiCard">
            <div class="kpiLabel">æº€è¶³åº¦ï¼ˆå¹³å‡ï¼‰</div>
            <div class="kpiValue">${fmtNum(site.satisfactionAvg,2)}</div>
            <div class="kpiDelta ${dSat.cls}">${dSat.text}</div>
            <div class="muted" style="margin-top:6px;font-size:12px;">å›ç­”æ•°=${site.sat_cnt}</div>
          </div>
          <div class="kpiCard">
            <div class="kpiLabel">ï¼ˆãƒ¢ãƒƒã‚¯æ ï¼‰</div>
            <div class="kpiValue">â€”</div>
            <div class="kpiDelta deltaFlat">â€”</div>
            <div class="muted" style="margin-top:6px;font-size:12px;">â€»æ‹¡å¼µç”¨</div>
          </div>
        </div>

        <div class="detailGrid">
          <div class="panelW">
            <div class="panelTitleW">èª²é¡Œ</div>
            <ul>${ai.issues.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>
            <div class="panelTitleW" style="margin-top:12px;">åŸå› </div>
            <ul>${ai.causes.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>
          </div>
          <div class="panelW">
            <div class="panelTitleW">æ”¹å–„æ–½ç­–</div>
            <ol>${ai.actions.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ol>
            <div class="panelTitleW" style="margin-top:12px;">å‚¾å‘</div>
            <ul>${ai.trends.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>
          </div>
        </div>
      `;

      const sel = body.querySelector("#siteSelect2");
      sel.innerHTML = sites.map(s => {
        const selected = s.siteName === site.siteName ? "selected" : "";
        return `<option value="${escapeHtml(s.siteName)}" ${selected}>${escapeHtml(s.siteName)}</option>`;
      }).join("");

      sel.addEventListener("change", () => {
        const nextSite = sites.find(s => s.siteName === sel.value);
        if (!nextSite) return;
        renderSiteDetailModal2({ site: nextSite, prefCode, monthLabel });
      });
    }

    function openSiteDetailFromPopup2(siteName, prefCode) {
      const st = (currentMonthMode2 === "prev") ? statePrev2 : stateCurr2;
      const prefAgg = st.byPref.get(prefCode);
      const site = prefAgg?.sites?.find(s => s.siteName === siteName);
      if (!site) return;
      openModal2();
      renderSiteDetailModal2({ site, prefCode, monthLabel: currentMonthMode2 === "prev" ? "å…ˆæœˆ" : "ä»Šæœˆ" });
    }

    function openSiteDetail(siteName) {
      const prefCode = siteToPrefCode.get(siteName);
      if (!prefCode) { alert("éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ãŒä¸æ˜ãªæ‹ ç‚¹ã§ã™: " + siteName); return; }
      if (window.__MAP_INIT_DONE__ !== true) {
        const mapTabBtn = document.querySelectorAll('.tab')[1];
        switchTab('map', mapTabBtn);
      }
      const st = (currentMonthMode2 === "prev") ? statePrev2 : stateCurr2;
      const prefAgg = st.byPref.get(prefCode);
      const site = prefAgg?.sites?.find(s => s.siteName === siteName);
      if (!site) { alert("è©²å½“æ‹ ç‚¹ã®é›†è¨ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆTSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ï¼‰: " + siteName); return; }
      openModal2();
      renderSiteDetailModal2({ site, prefCode, monthLabel: currentMonthMode2 === "prev" ? "å…ˆæœˆ" : "ä»Šæœˆ" });
      lastPrefPopupContext2 = { prefCode, anchor: null };
    }

    function wirePrefClick2(svg) {
      document.getElementById("prefPopupClose2").addEventListener("click", hidePrefPopup2);

      document.getElementById("mapContainer2").addEventListener("click", (e) => {
        const isPref = e.target.closest && e.target.closest(".prefecture");
        const isPopup = e.target.closest && e.target.closest("#prefPopup2");
        if (!isPref && !isPopup) hidePrefPopup2();
      });

      svg.querySelectorAll(".prefecture").forEach(el => {
        el.addEventListener("click", (e) => {
          e.stopPropagation();
          const { byPref, metricKey, monthLabel } = getActiveState2();
          const prefCode = Number(el.getAttribute("data-code"));
          const prefAgg = byPref.get(prefCode);
          if (!prefAgg) { hidePrefPopup2(); return; }
          showPrefPopup2({ prefEl: el, prefCode, prefAgg, metricKey, monthLabel, anchorEvent: e });
        });
      });
    }

    function debugTopValues(rows, colName, limit=5) {
      const vals = rows.map(r => String(r[colName] ?? "").trim()).filter(Boolean);
      const counts = new Map();
      for (const v of vals) counts.set(v, (counts.get(v)||0)+1);
      return [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,limit);
    }
    function looksLikeWorkHoursTop(topPairs) {
      const s = topPairs.map(([v])=>String(v));
      return s.some(v => v.includes("æ™‚é–“ä»¥å†…") || v.includes("æ™‚é–“ä»¥ä¸Š") || v.includes("4ã€œ6") || v.includes("ã€œ"));
    }

    function loadFromTextareas2(fromOverview=false) {
      const id = (x)=>document.getElementById(x);

      const prev1 = parseTable(id(fromOverview ? "ovTsvPrev1to5" : "tsvPrev1to5").value);
      const prev6 = parseTable(id(fromOverview ? "ovTsvPrev6to10" : "tsvPrev6to10").value);
      const curr1 = parseTable(id(fromOverview ? "ovTsvCurr1to5" : "tsvCurr1to5").value);
      const curr6 = parseTable(id(fromOverview ? "ovTsvCurr6to10" : "tsvCurr6to10").value);

      const topNextPrev = debugTopValues(prev1, "æ¬¡ã®äºˆç´„", 5);
      const topNextCurr = debugTopValues(curr1, "æ¬¡ã®äºˆç´„", 5);
      if (looksLikeWorkHoursTop(topNextPrev) || looksLikeWorkHoursTop(topNextCurr)) {
        alert("TSVã®åˆ—ã‚ºãƒ¬ã®å¯èƒ½æ€§ï¼šã€æ¬¡ã®äºˆç´„ã€åˆ—ã«å‹¤å‹™æ™‚é–“ï¼ˆ4æ™‚é–“ä»¥å†… ç­‰ï¼‰ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }

      const bySitePrev = aggregateSites(prev1, prev6);
      const bySiteCurr = aggregateSites(curr1, curr6);
      statePrev2 = buildPrefView(bySitePrev);
      stateCurr2 = buildPrefView(bySiteCurr);

      const msg =
        `èª­è¾¼: å…ˆæœˆ sites=${bySitePrev.size} / ä»Šæœˆ sites=${bySiteCurr.size}ï¼ˆæ¼ã‚Œ å…ˆæœˆ${statePrev2.unknownSites.length}ãƒ»ä»Šæœˆ${stateCurr2.unknownSites.length}ï¼‰`;

      if (fromOverview) document.getElementById("ovLoadStatus").textContent = msg;
      else document.getElementById("loadStatus").textContent = msg;

      const unknownAll = [...new Set([...statePrev2.unknownSites, ...stateCurr2.unknownSites])];
      const unknownMsg = unknownAll.length ? `âš ï¸ ãƒãƒƒãƒ”ãƒ³ã‚°æ¼ã‚Œï¼ˆæœ€å¤§20ä»¶ï¼‰: ${unknownAll.slice(0,20).join(" / ")}${unknownAll.length>20?" ...":""}` : "";
      const ub = document.getElementById("unknownBox");
      if (ub) ub.textContent = unknownMsg;

      if (svgRoot2) paintMap2(svgRoot2, getActiveState2().byPref, currentMetricKey2);
      hidePrefPopup2();

      refreshOverviewFromMapStates();
    }

    function makeRng(seed = 1) {
      let a = seed >>> 0;
      return function() {
        a |= 0; a = (a + 0x6D2B79F5) | 0;
        let t = Math.imul(a ^ (a >>> 15), 1 | a);
        t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function pick(rng, arr) { return arr[Math.floor(rng() * arr.length)]; }
    function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }
    function clampAvoidEdges(n, lo, hi, eps=1e-6){ return Math.max(lo+eps, Math.min(hi-eps, n)); }
    function pad2(n){ return String(n).padStart(2,"0"); }

    // =========================================================
    // Dummy distribution requirements:
    //  - äºˆç´„ç‡ 55â€“92%
    //  - æº€è¶³åº¦(å¹³å‡) 3.6â€“4.7
    //  - æŒ¨æ‹¶ãªã—ç‡ 1â€“18%
    //  - Î” -8ptã€œ+8ptï¼ˆè¡¨ç¤ºå´ã§ã‚‚ã‚¯ãƒ©ãƒ³ãƒ—ï¼‰
    // =========================================================
    const DUMMY_RANGES = {
      reserveYesRate: { lo: 0.55, hi: 0.92 },
      greetNoRate:    { lo: 0.01, hi: 0.18 }, // "ãªã—ç‡"
      satAvg:         { lo: 3.6,  hi: 4.7  },
      deltaPt:        { lo: -8,   hi: 8    }
    };

    function siteProfile2(siteName, monthLabel) {
      // siteã”ã¨ã®ä¸­å¿ƒã‚’ä½œã‚‹ï¼ˆå®‰å®šï¼‰
      let h = 2166136261;
      for (let i=0;i<siteName.length;i++) h = Math.imul(h ^ siteName.charCodeAt(i), 16777619);
      const p = (h >>> 0) / 4294967296;
      const center = (p - 0.5);

      const monthBias = monthLabel.startsWith("Jan") ? -0.012 : +0.010; // å°ã•ã‚ï¼ˆÎ”ãŒæš´ã‚Œãªã„ï¼‰
      const satBias   = monthLabel.startsWith("Jan") ? -0.04  : +0.035;

      // äºˆç´„ yesç‡
      const reserve = clampAvoidEdges(0.74 + center * 0.22 + monthBias, DUMMY_RANGES.reserveYesRate.lo, DUMMY_RANGES.reserveYesRate.hi);

      // æŒ¨æ‹¶ "ãªã—ç‡" ã‚’ç›´æ¥ä½œã£ã¦ã‹ã‚‰ yesç‡ã¸ï¼ˆ1â€“18%å³å®ˆï¼‰
      const greetNo = clampAvoidEdges(0.08 - center * 0.06 - monthBias*0.5, DUMMY_RANGES.greetNoRate.lo, DUMMY_RANGES.greetNoRate.hi);
      const introYes = 1 - greetNo;

      // æº€è¶³åº¦å¹³å‡ï¼ˆé€£ç¶šå€¤ã®ä¸­å¿ƒï¼‰
      const satCenter = clamp(4.10 + center * 0.45 + satBias, DUMMY_RANGES.satAvg.lo, DUMMY_RANGES.satAvg.hi);

      return { reserveYesRate: reserve, introYesRate: introYes, satCenter };
    }

    // =========================================================
    // Dummy (FAST): generate states directly without textarea
    // =========================================================
    function generateDummyStatesDirect(monthLabel, { seed = 1, totalPerMonth = 3000 } = {}) {
      const rng = makeRng(seed);
      const sites = [...siteToPrefCode.keys()];

      // å¾“æ¥ã®æ¯”ç‡(64:36)ã‚’è¸è¥²
      const n1 = Math.round(totalPerMonth * 0.64);
      const n6 = totalPerMonth - n1;

      const bySite = new Map();
      const get = (siteName) => {
        if (!bySite.has(siteName)) {
          bySite.set(siteName, { siteName, next_num:0, next_den:0, sat_sum:0, sat_cnt:0, greet_no:0, greet_den:0 });
        }
        return bySite.get(siteName);
      };

      // 1ã€œ5å›ç›®ï¼šäºˆç´„ + æº€è¶³ + è‡ªå·±ç´¹ä»‹
      for (let i=0;i<n1;i++) {
        const site = pick(rng, sites);
        const prof = siteProfile2(site, monthLabel);
        const a = get(site);

        // reserve
        const nextYes = (rng() < prof.reserveYesRate);
        a.next_den++;
        if (nextYes) a.next_num++;

        // satisfaction: 1ã€œ5æ•´æ•°ã ãŒã€å¹³å‡ãŒ3.6ã€œ4.7ã«å¯„ã‚‹ã‚ˆã†ä¸­å¿ƒã‚’è¨­è¨ˆ
        // ä½è©•ä¾¡(1,2)ã‚’ã»ã¼å‡ºã•ãªã„
        let sat = Math.round(prof.satCenter + (rng()-0.5)*0.70);
        sat = clamp(sat, 3, 5);
        // ãŸã¾ã«2ã‚’å‡ºã™ãŒæ¥µå°
        if (sat === 3 && rng() < 0.03) sat = 2;
        a.sat_sum += sat; a.sat_cnt++;

        // greet intro: yesç‡ = 1 - (ãªã—ç‡)
        const introYes = (rng() < prof.introYesRate);
        a.greet_den++;
        if (!introYes) a.greet_no++;
      }

      // 6ã€œ10å›ç›®ï¼šæº€è¶³ + è‡ªå·±ç´¹ä»‹
      for (let i=0;i<n6;i++) {
        const site = pick(rng, sites);
        const prof = siteProfile2(site, monthLabel);
        const a = get(site);

        let sat = Math.round((prof.satCenter + 0.05) + (rng()-0.5)*0.70);
        sat = clamp(sat, 3, 5);
        if (sat === 3 && rng() < 0.025) sat = 2;
        a.sat_sum += sat; a.sat_cnt++;

        const introYes = (rng() < prof.introYesRate);
        a.greet_den++;
        if (!introYes) a.greet_no++;
      }

      return buildPrefView(bySite);
    }

    // =========================================================
    // TSVç”Ÿæˆï¼ˆgenerateDummyTSV(monthLabel, opts) ã‚’å®Ÿé‹ç”¨ã«æ¥ç¶šï¼‰
    //  - opts.totalPerMonth ãŒæ¥ãŸã‚‰ 64:36 ã§ n1/n6 ã‚’æ±ºã‚ã‚‹
    // =========================================================
    function generateDummyTSV(monthLabel, opts = {}) {
      const rng = makeRng(opts.seed ?? 1);

      const sites = [...siteToPrefCode.keys()];
      const leaders = ["é«˜æ©‹","éˆ´æœ¨","ç”°ä¸­","ä½è—¤","æµ·é‡","æ¸¡è¾º","ä¼Šè—¤","å°æ—"];
      const occs = ["å¤§å­¦ç”Ÿ","é«˜æ ¡ç”Ÿ","ä¼šç¤¾å“¡","ãƒ•ãƒªãƒ¼ã‚¿ãƒ¼","ä¸»å©¦/ä¸»å¤«"];
      const triggers = ["ãŸã¾ãŸã¾","SNS","æ±‚äººã‚’è¦‹ã¦","ä»¥å‰åƒã„ãŸã“ã¨ãŒã‚ã‚‹"];
      const workHours = ["4æ™‚é–“ä»¥å†…","4ã€œ6æ™‚é–“","6æ™‚é–“ä»¥ä¸Š"];
      const smell = ["å•é¡Œãªã—","æ™®é€š","è‡­ã„"];

      const totalPerMonth = Number(opts.totalPerMonth ?? 500); // TSVã¯å·¨å¤§åŒ–ã—ã‚„ã™ã„ã®ã§æ—¢å®šã¯500ï¼ˆstateã¯åˆ¥ã§3000ï¼‰
      const n1 = Math.round(totalPerMonth * 0.64);
      const n6 = totalPerMonth - n1;

      const header1 = [
        "é€ä¿¡æ—¥æ™‚","month","å‹¤å‹™å…ˆ","æ°åï¼ˆã¾ãŸã¯ã‚¢ãƒ«ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ï¼‰","å‡ºå‹¤å›æ•°","è·æ¥­","ã‚¢ãƒ¼ãƒˆã«ããŸãã£ã‹ã‘",
        "é¢æ¥å®˜ã®å¯¾å¿œ","é¢æ¥å®˜ã®å¯¾å¿œã®è‰¯ã‹ã£ãŸç†ç”±","é¢æ¥å®˜ã®å¯¾å¿œã®æ‚ªã‹ã£ãŸç†ç”±","ãƒªãƒ¼ãƒ€ãƒ¼å","ãƒªãƒ¼ãƒ€ãƒ¼ã‹ã‚‰ã®è‡ªå·±ç´¹ä»‹",
        "ä½œæ¥­å†…å®¹ãƒ»ä¸€æ—¥ã®æµã‚Œã®è©±ãŒã‚ã£ãŸã‹","ç€ã‚‹å‰ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã®ç—›ã¿ã‚„åŒ‚ã„","åƒã„ãŸæ™‚é–“","æ¬¡ã®äºˆç´„","äºˆç´„ã‚’å…¥ã‚Œãªã‹ã£ãŸç†ç”±",
        "ãƒªãƒ¼ãƒ€ãƒ¼ã¨ã¾ãŸä½œæ¥­ã‚’ã—ãŸã„ã§ã™ã‹ï¼Ÿ","è¡ŒããŸã„ç†ç”±","è¡ŒããŸããªã„ç†ç”±","æº€è¶³åº¦","ãã®ä»–ã”æ„è¦‹"
      ];

      const header6 = [
        "é€ä¿¡æ—¥æ™‚","month","å‹¤å‹™å…ˆ","æ°åï¼ˆã¾ãŸã¯ã‚¢ãƒ«ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ï¼‰","å‡ºå‹¤å›æ•°","ãƒªãƒ¼ãƒ€ãƒ¼å","ãƒªãƒ¼ãƒ€ãƒ¼ã‹ã‚‰ã®è‡ªå·±ç´¹ä»‹",
        "ä½œæ¥­å†…å®¹ãƒ»ä¸€æ—¥ã®æµã‚Œã®è©±ãŒã‚ã£ãŸã‹","ç€ã‚‹å‰ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã®ç—›ã¿ã‚„åŒ‚ã„","å¸Œæœ›æ—¥æ™‚ã«åƒã‘ã¦ã„ã‚‹ã‹","å¸Œæœ›æ—¥ã«åƒã‘ãªã‹ã£ãŸæ—¥",
        "ãƒªãƒ¼ãƒ€ãƒ¼ã¨ã¾ãŸä½œæ¥­ã‚’ã—ãŸã„ã§ã™ã‹ï¼Ÿ","è¡ŒããŸã„ç†ç”±","è¡ŒããŸããªã„ç†ç”±","æº€è¶³åº¦","æ”¹å–„ã—ã¦ã»ã—ã„ã“ã¨","å†…å‹¤è€…ã¸ã®è‰¯ã‹ã£ãŸãƒ»æ‚ªã‹ã£ãŸç‚¹","ç¶™ç¶šã«ã‚ãŸã£ã¦ã®è¦æœ›"
      ];

      function makeDatetime() {
        const monthNum = monthLabel.startsWith("Jan") ? 1 : 2;
        const day = 1 + Math.floor(rng() * 28);
        const hh = Math.floor(rng() * 23);
        const mm = Math.floor(rng() * 59);
        return `2026/${monthNum}/${pad2(day)} ${pad2(hh)}:${pad2(mm)}`;
      }
      function makeCode(prefix, base) {
        return `${prefix}-${String(base).padStart(4,"0")}`;
      }

      function buildRow(header, setFn) {
        const row = Array(header.length).fill("");
        const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
        setFn(row, idx);
        return row.join("\t");
      }

      const prefix = monthLabel === "Jan-26" ? "A202601" : "A202602";

      const rows1 = [header1.join("\t")];
      for (let i=0;i<n1;i++) {
        const site = pick(rng, sites);
        const prof = siteProfile2(site, monthLabel);

        const dt = makeDatetime();
        const code = makeCode(prefix, 1000 + i);
        const attendance = `${1 + Math.floor(rng() * 5)}å›ç›®`;

        const intro = (rng() < prof.introYesRate) ? "ã¯ã„" : "ã„ã„ãˆ";
        const next  = (rng() < prof.reserveYesRate) ? "ã„ã‚ŒãŸ" : "ã„ã‚Œãªã„";

        let sat = Math.round(prof.satCenter + (rng()-0.5)*0.70);
        sat = clamp(sat, 3, 5);
        if (sat === 3 && rng() < 0.03) sat = 2;

        const notReserveReason = (next === "ã„ã‚Œãªã„")
          ? pick(rng, ["åˆ¥ã®ãƒã‚¤ãƒˆãŒå¿™ã—ã„","æŒ‡ç¤ºãŒåˆ†ã‹ã‚Šã«ãã„","ä¼šè©±ãŒå°‘ãªã„/é›‘ã«æ‰±ã‚ã‚ŒãŸ","ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ãŒè‡­ã„/ç—›ã„","äºˆå®šãŒåˆã‚ãªã„"])
          : "";

        rows1.push(buildRow(header1, (row, idx) => {
          row[idx["é€ä¿¡æ—¥æ™‚"]] = dt;
          row[idx["month"]] = monthLabel;
          row[idx["å‹¤å‹™å…ˆ"]] = site;
          row[idx["æ°åï¼ˆã¾ãŸã¯ã‚¢ãƒ«ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ï¼‰"]] = code;
          row[idx["å‡ºå‹¤å›æ•°"]] = attendance;
          row[idx["è·æ¥­"]] = pick(rng, occs);
          row[idx["ã‚¢ãƒ¼ãƒˆã«ããŸãã£ã‹ã‘"]] = pick(rng, triggers);
          row[idx["é¢æ¥å®˜ã®å¯¾å¿œ"]] = "è‰¯ã‹ã£ãŸ";
          row[idx["é¢æ¥å®˜ã®å¯¾å¿œã®è‰¯ã‹ã£ãŸç†ç”±"]] = "åˆ†ã‹ã‚Šã‚„ã™ã‹ã£ãŸ";
          row[idx["é¢æ¥å®˜ã®å¯¾å¿œã®æ‚ªã‹ã£ãŸç†ç”±"]] = "";
          row[idx["ãƒªãƒ¼ãƒ€ãƒ¼å"]] = pick(rng, leaders);
          row[idx["ãƒªãƒ¼ãƒ€ãƒ¼ã‹ã‚‰ã®è‡ªå·±ç´¹ä»‹"]] = intro;
          row[idx["ä½œæ¥­å†…å®¹ãƒ»ä¸€æ—¥ã®æµã‚Œã®è©±ãŒã‚ã£ãŸã‹"]] = (rng() < 0.90) ? "ã¯ã„" : "ã„ã„ãˆ";
          row[idx["ç€ã‚‹å‰ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã®ç—›ã¿ã‚„åŒ‚ã„"]] = pick(rng, smell);
          row[idx["åƒã„ãŸæ™‚é–“"]] = pick(rng, workHours);
          row[idx["æ¬¡ã®äºˆç´„"]] = next;
          row[idx["äºˆç´„ã‚’å…¥ã‚Œãªã‹ã£ãŸç†ç”±"]] = notReserveReason;
          row[idx["ãƒªãƒ¼ãƒ€ãƒ¼ã¨ã¾ãŸä½œæ¥­ã‚’ã—ãŸã„ã§ã™ã‹ï¼Ÿ"]] = (rng() < 0.80) ? "ã¯ã„" : "ã„ã„ãˆ";
          row[idx["è¡ŒããŸã„ç†ç”±"]] = pick(rng, ["ç¨¼ã’ã‚‹","ç¨¼ã’ã‚‹/æ…£ã‚ŒãŸ","äººé–“é–¢ä¿‚ãŒè‰¯ã„","èé€šãŒãã"]);
          row[idx["è¡ŒããŸããªã„ç†ç”±"]] = "";
          row[idx["æº€è¶³åº¦"]] = String(sat);
          row[idx["ãã®ä»–ã”æ„è¦‹"]] = "";
        }));
      }

      const rows6 = [header6.join("\t")];
      for (let i=0;i<n6;i++) {
        const site = pick(rng, sites);
        const prof = siteProfile2(site, monthLabel);

        const dt = makeDatetime();
        const code = makeCode(prefix, 2000 + i);
        const attendance = `${6 + Math.floor(rng() * 5)}å›ç›®`;
        const intro = (rng() < prof.introYesRate) ? "ã¯ã„" : "ã„ã„ãˆ";

        let sat = Math.round((prof.satCenter + 0.05) + (rng()-0.5)*0.70);
        sat = clamp(sat, 3, 5);
        if (sat === 3 && rng() < 0.025) sat = 2;

        rows6.push(buildRow(header6, (row, idx) => {
          row[idx["é€ä¿¡æ—¥æ™‚"]] = dt;
          row[idx["month"]] = monthLabel;
          row[idx["å‹¤å‹™å…ˆ"]] = site;
          row[idx["æ°åï¼ˆã¾ãŸã¯ã‚¢ãƒ«ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ï¼‰"]] = code;
          row[idx["å‡ºå‹¤å›æ•°"]] = attendance;
          row[idx["ãƒªãƒ¼ãƒ€ãƒ¼å"]] = pick(rng, leaders);
          row[idx["ãƒªãƒ¼ãƒ€ãƒ¼ã‹ã‚‰ã®è‡ªå·±ç´¹ä»‹"]] = intro;
          row[idx["ä½œæ¥­å†…å®¹ãƒ»ä¸€æ—¥ã®æµã‚Œã®è©±ãŒã‚ã£ãŸã‹"]] = (rng() < 0.85) ? "ã¯ã„" : "ã„ã„ãˆ";
          row[idx["ç€ã‚‹å‰ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã®ç—›ã¿ã‚„åŒ‚ã„"]] = pick(rng, smell);
          row[idx["å¸Œæœ›æ—¥æ™‚ã«åƒã‘ã¦ã„ã‚‹ã‹"]] = (rng() < 0.75) ? "ã¯ã„" : "ã„ã„ãˆ";
          row[idx["å¸Œæœ›æ—¥ã«åƒã‘ãªã‹ã£ãŸæ—¥"]] = "";
          row[idx["ãƒªãƒ¼ãƒ€ãƒ¼ã¨ã¾ãŸä½œæ¥­ã‚’ã—ãŸã„ã§ã™ã‹ï¼Ÿ"]] = (rng() < 0.75) ? "ã¯ã„" : "ã„ã„ãˆ";
          row[idx["è¡ŒããŸã„ç†ç”±"]] = "ç¨¼ã’ã‚‹/æ…£ã‚ŒãŸ";
          row[idx["è¡ŒããŸããªã„ç†ç”±"]] = "";
          row[idx["æº€è¶³åº¦"]] = String(sat);
          row[idx["æ”¹å–„ã—ã¦ã»ã—ã„ã“ã¨"]] = "";
          row[idx["å†…å‹¤è€…ã¸ã®è‰¯ã‹ã£ãŸãƒ»æ‚ªã‹ã£ãŸç‚¹"]] = (rng() < 0.7) ? "é€£çµ¡ãŒæ—©ã„" : "é€£çµ¡ãŒé…ã„";
          row[idx["ç¶™ç¶šã«ã‚ãŸã£ã¦ã®è¦æœ›"]] = "";
        }));
      }

      return { tsv1: rows1.join("\n"), tsv6: rows6.join("\n") };
    }

    // =========================================================
    // Dummy button behavior: ensure generateDummyTSV + textarea + load pipeline
    // =========================================================
    function fillDummyToTextareasAndLoad({ fromOverview, totalPerMonthState = 3000, totalPerMonthTSV = 500 } = {}) {
      // 1) stateé«˜é€Ÿç”Ÿæˆï¼ˆ3000ä»¶ï¼‰
      statePrev2 = generateDummyStatesDirect("Jan-26", { seed: 1, totalPerMonth: totalPerMonthState });
      stateCurr2 = generateDummyStatesDirect("Feb-26", { seed: 2, totalPerMonth: totalPerMonthState });

      // 2) TSVç”Ÿæˆï¼ˆé‡ãã—ãªã„ãŸã‚500ä»¶æ—¢å®šã€‚è¦ä»¶ã®ã€ŒgenerateDummyTSVé€£æºã€æº€ãŸã™ï¼‰
      const prev = generateDummyTSV("Jan-26", { seed: 1, totalPerMonth: totalPerMonthTSV });
      const curr = generateDummyTSV("Feb-26", { seed: 2, totalPerMonth: totalPerMonthTSV });

      const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };

      if (fromOverview) {
        setVal("ovTsvPrev1to5", prev.tsv1);
        setVal("ovTsvPrev6to10", prev.tsv6);
        setVal("ovTsvCurr1to5", curr.tsv1);
        setVal("ovTsvCurr6to10", curr.tsv6);
      } else {
        setVal("tsvPrev1to5", prev.tsv1);
        setVal("tsvPrev6to10", prev.tsv6);
        setVal("tsvCurr1to5", curr.tsv1);
        setVal("tsvCurr6to10", curr.tsv6);
      }

      // 3) è²¼ä»˜ã¨åŒã˜åæ˜ çµŒè·¯ã§çµ±ä¸€
      loadFromTextareas2(!!fromOverview);
    }

    function setMetric2(key) {
      currentMetricKey2 = key;
      document.getElementById("metric-next").classList.toggle("primary", key==="next");
      document.getElementById("metric-sat").classList.toggle("primary", key==="sat");
      document.getElementById("metric-greet").classList.toggle("primary", key==="greet");
      if (svgRoot2) paintMap2(svgRoot2, getActiveState2().byPref, currentMetricKey2);
      refreshOverviewFromMapStates();
    }

    function setMonth2(mode) {
      currentMonthMode2 = mode;
      document.getElementById("month-curr").classList.toggle("primary", mode==="curr");
      document.getElementById("month-prev").classList.toggle("primary", mode==="prev");
      if (svgRoot2) paintMap2(svgRoot2, getActiveState2().byPref, currentMetricKey2);
      refreshOverviewFromMapStates();
    }

    function initMapTab() {
      (async () => {
        try {
          svgRoot2 = await loadJapanSvg2("./japan.svg");
          wirePrefClick2(svgRoot2);

          document.getElementById("prefPopupClose2").addEventListener("click", hidePrefPopup2);

          document.getElementById("prefPopup2").addEventListener("click", (e) => {
            const btn = e.target.closest?.(".popupSiteBtn");
            if (!btn) return;
            e.preventDefault();
            e.stopPropagation();
            const siteName = btn.getAttribute("data-site");
            const prefCode = Number(btn.getAttribute("data-pref"));
            if (!siteName || !prefCode) return;
            openSiteDetailFromPopup2(siteName, prefCode);
          });

          document.getElementById("btnCloseModal2").addEventListener("click", () => closeModal2());
          document.getElementById("siteDetailModal2").addEventListener("click", (e) => {
            const close = e.target?.getAttribute?.("data-close");
            if (close) document.getElementById("btnCloseModal2").click();
          });
          window.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              const m = document.getElementById("siteDetailModal2");
              if (m.classList.contains("is-open")) document.getElementById("btnCloseModal2").click();
            }
          });

          document.getElementById("metric-next").addEventListener("click", ()=>setMetric2("next"));
          document.getElementById("metric-sat").addEventListener("click", ()=>setMetric2("sat"));
          document.getElementById("metric-greet").addEventListener("click", ()=>setMetric2("greet"));
          document.getElementById("month-curr").addEventListener("click", ()=>setMonth2("curr"));
          document.getElementById("month-prev").addEventListener("click", ()=>setMonth2("prev"));

          document.getElementById("btnLoad").addEventListener("click", () => {
            try { loadFromTextareas2(false); setMonth2("curr"); }
            catch (e) { console.error(e); alert("æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ã€‚F12â†’Consoleã®èµ¤ã„è¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); }
          });

          // Dummy: state(3000) + TSV(500) + load pipeline
          document.getElementById("btnFillDummy").addEventListener("click", () => {
            try {
              fillDummyToTextareasAndLoad({ fromOverview:false, totalPerMonthState:3000, totalPerMonthTSV:500 });
              document.getElementById("loadStatus").textContent = `ãƒ€ãƒŸãƒ¼ç”Ÿæˆ: å„æœˆ3000ä»¶ï¼ˆé«˜é€Ÿï¼‰ / TSVæŠ•å…¥(å„æœˆ500ä»¶)`;
              setMonth2("curr");
            } catch (e) {
              console.error(e);
              alert("ãƒ€ãƒŸãƒ¼å…¥åŠ›ã§ã‚¨ãƒ©ãƒ¼ã€‚F12â†’Consoleã®èµ¤ã„è¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
          });

          paintMap2(svgRoot2, new Map(), currentMetricKey2);
          document.getElementById("mapStatus2").textContent += "ï¼ˆTSVã‚’è²¼ã‚Šä»˜ã‘ã¦ã€æ›´æ–°ã€ã—ã¦ãã ã•ã„ã€‚ãƒ€ãƒŸãƒ¼é«˜é€Ÿã‚‚å¯ï¼‰";
        } catch (e) {
          console.error(e);
          document.getElementById("mapStatus2").textContent = "åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ã€‚F12â†’Consoleã®èµ¤ã„è¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        }
      })();
    }

    /* =========================================================
      â‘  Overview tab
    ========================================================= */
    let ovMetricKey = "next";
    let ovMonthMode = "curr";

    function initOverviewTab() {
      document.getElementById("ov-metric-next").addEventListener("click", ()=>setOvMetric("next"));
      document.getElementById("ov-metric-sat").addEventListener("click", ()=>setOvMetric("sat"));
      document.getElementById("ov-metric-greet").addEventListener("click", ()=>setOvMetric("greet"));
      document.getElementById("ov-month-curr").addEventListener("click", ()=>setOvMonth("curr"));
      document.getElementById("ov-month-prev").addEventListener("click", ()=>setOvMonth("prev"));

      document.getElementById("ovBtnLoad").addEventListener("click", () => {
        try { loadFromTextareas2(true); }
        catch (e) { console.error(e); alert("â‘ ã®æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ã€‚F12â†’Consoleã®èµ¤ã„è¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); }
      });

      document.getElementById("ovBtnFillDummy").addEventListener("click", () => {
        try {
          fillDummyToTextareasAndLoad({ fromOverview:true, totalPerMonthState:3000, totalPerMonthTSV:500 });
          document.getElementById("ovLoadStatus").textContent = `ãƒ€ãƒŸãƒ¼ç”Ÿæˆ: å„æœˆ3000ä»¶ï¼ˆé«˜é€Ÿï¼‰ / TSVæŠ•å…¥(å„æœˆ500ä»¶)`;
        } catch (e) {
          console.error(e);
          alert("â‘ ãƒ€ãƒŸãƒ¼å…¥åŠ›ã§ã‚¨ãƒ©ãƒ¼ã€‚F12â†’Consoleã®èµ¤ã„è¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
      });

      setAiSummaryMock();
      refreshOverviewFromMapStates();
    }

    function setOvMetric(k){
      ovMetricKey = k;
      document.getElementById("ov-metric-next").classList.toggle("active", k==="next");
      document.getElementById("ov-metric-sat").classList.toggle("active", k==="sat");
      document.getElementById("ov-metric-greet").classList.toggle("active", k==="greet");
      refreshOverviewFromMapStates();
    }
    function setOvMonth(m){
      ovMonthMode = m;
      document.getElementById("ov-month-curr").classList.toggle("active", m==="curr");
      document.getElementById("ov-month-prev").classList.toggle("active", m==="prev");
      refreshOverviewFromMapStates();
    }

    function setAiSummaryMock(){
      const issues = [
        "æ‹ ç‚¹é–“ã®ä½“é¨“å“è³ªã«ãƒ ãƒ©ï¼ˆäºˆç´„ç‡ãƒ»æŒ¨æ‹¶ãªã—ç‡ã§å·®ãŒå‡ºã‚„ã™ã„ï¼‰",
        "åˆå›ï¼ˆ1ã€œ5å›ç›®ï¼‰ã§ã®é›¢è„±å…†å€™ãŒè¦‹ãˆã‚‹æ‹ ç‚¹ãŒã‚ã‚‹"
      ];
      const causes = [
        "å°å…¥ï¼ˆè‡ªå·±ç´¹ä»‹/æµã‚Œèª¬æ˜ï¼‰ã®çœç•¥ãŒãƒ”ãƒ¼ã‚¯æ™‚ã«èµ·ãã‚‹",
        "æ¬¡å›äºˆç´„ã®ææ¡ˆãŒæ‹…å½“è€…ä¾å­˜ã«ãªã£ã¦ã„ã‚‹"
      ];
      const actions = [
        "å°å…¥30ç§’ï¼ˆè‡ªå·±ç´¹ä»‹â†’æµã‚Œâ†’è³ªå•ï¼‰ã‚’æ¨™æº–åŒ–",
        "çµ‚äº†å‰5åˆ†ã®äºˆç´„ææ¡ˆãƒ†ãƒ³ãƒ—ãƒ¬ï¼‹QRå°ç·šã‚’çµ±ä¸€"
      ];
      const trends = [
        "ã€é€£çµ¡ã€ã€æŒ‡ç¤ºã€ç³»ã®æ”¹å–„è¦æœ›ãŒå‡ºã‚„ã™ã„ï¼ˆâ‘£ã§æ ¹æ‹ ç¢ºèªï¼‰",
        "æ¯æ•°ãŒå°ã•ã„æ‹ ç‚¹ã¯ç‡ãŒæŒ¯ã‚Œã‚„ã™ã„ã®ã§å›ç­”æ•°ä½µè¨˜ã§åˆ¤æ–­"
      ];

      const fill = (id, arr) => {
        const el = document.getElementById(id);
        el.innerHTML = arr.map(x => `<li>${escapeHtml(x)}</li>`).join("");
      };
      fill("ovAiIssues", issues);
      fill("ovAiCauses", causes);
      fill("ovAiActions", actions);
      fill("ovAiTrends", trends);
    }

    function flattenSitesFromState(state){
      const out = [];
      for (const p of state.byPref.values()){
        for (const s of (p.sites || [])) out.push(s);
      }
      const m = new Map();
      for (const s of out) m.set(s.siteName, s);
      return [...m.values()];
    }

    function metricValue(site, metricKey){
      if (metricKey === "next") return site.nextReservationRate;
      if (metricKey === "sat") return site.satisfactionAvg;
      if (metricKey === "greet") return site.noGreetingRate;
      return null;
    }
    function metricDen(site, metricKey){
      if (metricKey === "next") return site.next_den;
      if (metricKey === "sat") return site.sat_cnt;
      if (metricKey === "greet") return site.greet_den;
      return 0;
    }
    function formatMetric(metricKey, v){
      if (v == null) return "â€”";
      if (metricKey === "sat") return v.toFixed(2);
      return v.toFixed(1) + "%";
    }
    function deltaForMetric(metricKey, curr, prev){
      if (curr == null || prev == null) return null;
      return curr - prev;
    }
    function improvementScore(metricKey, delta){
      if (delta == null) return null;
      if (metricKey === "greet") return -delta;
      return delta;
    }

    function renderSiteDeltaTable(elId, rows){
      const el = document.getElementById(elId);
      el.innerHTML = `
        <tr><th>æ‹ ç‚¹</th><th>ä»Šæœˆ</th><th>å‰æœˆæ¯”(Î”)</th><th>å›ç­”æ•°</th></tr>
        ${rows.map(r => `
          <tr>
            <td><span class="link" data-site="${escapeHtml(r.siteName)}">${escapeHtml(r.siteName)}</span></td>
            <td>${escapeHtml(r.currText)}</td>
            <td>${r.deltaText}</td>
            <td>${r.n}</td>
          </tr>
        `).join("")}
      `;
      el.querySelectorAll("[data-site]").forEach(a => {
        a.addEventListener("click", () => openSiteDetail(a.getAttribute("data-site")));
      });
    }

    function setDeltaEl(id, d, mode){
      const el = document.getElementById(id);
      if (d == null) { el.textContent="â€”"; el.className="deltaFlat"; return; }
      if (d > 0.0001) { el.className="deltaUp"; el.textContent = (mode==="int"?`+${Math.round(d)}`:mode==="pct"?`+${d.toFixed(1)}%`:`+${d.toFixed(2)}`); return; }
      if (d < -0.0001) { el.className="deltaDown"; el.textContent = (mode==="int"?`${Math.round(d)}`:mode==="pct"?`${d.toFixed(1)}%`:`${d.toFixed(2)}`); return; }
      el.className="deltaFlat"; el.textContent = (mode==="int"?"Â±0":mode==="pct"?"Â±0.0%":"Â±0.00");
    }

    function refreshOverviewFromMapStates(){
      const monthLabel = ovMonthMode === "prev" ? "å…ˆæœˆ" : "ä»Šæœˆ";
      document.getElementById("ovKpiMonthLabel").textContent = monthLabel;

      const stCurr = stateCurr2;
      const stPrev = statePrev2;
      const hasAny = (stCurr.byPref && stCurr.byPref.size) || (stPrev.byPref && stPrev.byPref.size);

      if (!hasAny) {
        document.getElementById("ov-dataStatus").textContent = `ï¼ˆãƒ‡ãƒ¼ã‚¿: TSVæœªèª­è¾¼ãªã‚‰â€”ï¼‰`;
        document.getElementById("ovKpiResponses").textContent = "â€”";
        document.getElementById("ovKpiReserve").textContent = "â€”";
        document.getElementById("ovKpiReserveN").textContent = "â€”";
        document.getElementById("ovKpiSat").textContent = "â€”";
        document.getElementById("ovKpiSatN").textContent = "â€”";
        setDeltaEl("ovDeltaResponses", null, "int");
        setDeltaEl("ovDeltaReserve", null, "pct");
        setDeltaEl("ovDeltaSat", null, "num");
        document.getElementById("ovImproveTop5").innerHTML = `<tr><th>æ‹ ç‚¹</th><th>ä»Šæœˆ</th><th>å‰æœˆæ¯”</th><th>å›ç­”æ•°</th></tr><tr><td colspan="4" class="muted">â‘¡ã¾ãŸã¯â‘ ã§TSVã‚’èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ï¼ˆãƒ€ãƒŸãƒ¼é«˜é€Ÿã§ã‚‚OKï¼‰</td></tr>`;
        document.getElementById("ovWorst5").innerHTML = document.getElementById("ovImproveTop5").innerHTML;
      } else {
        const useState = ovMonthMode === "prev" ? stPrev : stCurr;
        const sitesNow = flattenSitesFromState(useState);

        const nResponses = sitesNow.reduce((a,s)=>a + (s.sat_cnt||0), 0);
        document.getElementById("ovKpiResponses").textContent = nResponses ? nResponses.toLocaleString("ja-JP") : "â€”";

        const aggCompany = (state) => {
          let next_num=0,next_den=0,sat_sum=0,sat_cnt=0;
          for (const p of state.byPref.values()){
            next_num += p.next_num||0; next_den += p.next_den||0;
            sat_sum += p.sat_sum||0; sat_cnt += p.sat_cnt||0;
          }
          return {
            reserve: calcRate(next_num, next_den),
            reserveN: next_den,
            sat: calcAvg(sat_sum, sat_cnt),
            satN: sat_cnt,
            responsesApprox: sat_cnt
          };
        };

        const compCurr = aggCompany(stCurr);
        const compPrev = aggCompany(stPrev);
        const compUse = (ovMonthMode==="prev") ? compPrev : compCurr;

        document.getElementById("ovKpiReserve").textContent = compUse.reserve==null ? "â€”" : (compUse.reserve.toFixed(1)+"%");
        document.getElementById("ovKpiReserveN").textContent = compUse.reserveN ? compUse.reserveN.toLocaleString("ja-JP") : "â€”";
        document.getElementById("ovKpiSat").textContent = compUse.sat==null ? "â€”" : compUse.sat.toFixed(2);
        document.getElementById("ovKpiSatN").textContent = compUse.satN ? compUse.satN.toLocaleString("ja-JP") : "â€”";

        const dResp = (compCurr.responsesApprox && compPrev.responsesApprox) ? (compCurr.responsesApprox - compPrev.responsesApprox) : null;
        const dReserveRaw = (compCurr.reserve!=null && compPrev.reserve!=null) ? (compCurr.reserve - compPrev.reserve) : null;
        const dSatRaw = (compCurr.sat!=null && compPrev.sat!=null) ? (compCurr.sat - compPrev.sat) : null;

        // Î”ã¯è¦ä»¶ã©ãŠã‚Šä¿é™ºã‚¯ãƒ©ãƒ³ãƒ—ï¼ˆè¡¨ç¤ºï¼‰
        const dReserve = dReserveRaw == null ? null : clamp(dReserveRaw, DUMMY_RANGES.deltaPt.lo, DUMMY_RANGES.deltaPt.hi);
        const dSat = dSatRaw == null ? null : clamp(dSatRaw, -0.8, 0.8);

        setDeltaEl("ovDeltaResponses", dResp, "int");
        setDeltaEl("ovDeltaReserve", dReserve, "pct");
        setDeltaEl("ovDeltaSat", dSat, "num");

        const currSites = flattenSitesFromState(stCurr);
        const prevSites = flattenSitesFromState(stPrev);
        const prevByName = new Map(prevSites.map(s=>[s.siteName, s]));

        // æŒ‡æ¨™ã”ã¨ã®MINå›ç­”æ•°ï¼ˆæ ¹æœ¬å¯¾ç­–ï¼‰
        const MIN_N_BY_METRIC = { next: 12, sat: 12, greet: 12 };
        const MIN_N = MIN_N_BY_METRIC[ovMetricKey] ?? 12;

        const rows = currSites.map(s => {
          const prev = prevByName.get(s.siteName);
          const currV = metricValue(s, ovMetricKey);
          const prevV = prev ? metricValue(prev, ovMetricKey) : null;

          let d = deltaForMetric(ovMetricKey, currV, prevV);
          if (d != null) {
            // Î”è¡¨ç¤ºã¯-8ã€œ+8ptã«ã‚¯ãƒ©ãƒ³ãƒ—ï¼ˆæº€è¶³åº¦ã¯Â±0.8é‹ç”¨ï¼‰
            if (ovMetricKey === "sat") d = clamp(d, -0.8, 0.8);
            else d = clamp(d, DUMMY_RANGES.deltaPt.lo, DUMMY_RANGES.deltaPt.hi);
          }

          const n = metricDen(s, ovMetricKey) || 0;
          if (n < MIN_N) return null;

          const score = improvementScore(ovMetricKey, d);
          const currText = formatMetric(ovMetricKey, currV);
          const deltaText = (d==null) ? "â€”"
            : (ovMetricKey==="sat"
                ? ((d>=0?"+":"") + d.toFixed(2))
                : ((d>=0?"+":"") + d.toFixed(1) + "%"));
          return { siteName: s.siteName, currText, deltaText, n, score };
        }).filter(Boolean).filter(r => r.score != null);

        const improve = rows.slice().sort((a,b)=> (b.score - a.score) || (b.n - a.n)).slice(0,5);
        const worst = rows.slice().sort((a,b)=> (a.score - b.score) || (b.n - a.n)).slice(0,5);

        renderSiteDeltaTable("ovImproveTop5", improve);
        renderSiteDeltaTable("ovWorst5", worst);

        document.getElementById("ov-dataStatus").textContent =
          `ï¼ˆæŒ‡æ¨™:${metricDefs[ovMetricKey].label} / å‰æœˆæ¯”ã§Topãƒ»Worstç®—å‡º / MINå›ç­”æ•°=${MIN_N} / Î”ã¯ã‚¯ãƒ©ãƒ³ãƒ—ï¼‰`;
      }

      renderOshiMock();
    }

    function renderOshiMock(){
      const el = document.getElementById("ovOshiTop5");
      const mock = [
        { leader:"ç”°ä¸­", site:"æ–°å®¿æ”¯åº—", votes: 42, n: 180 },
        { leader:"éˆ´æœ¨", site:"ä»™å°æ±å£ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", votes: 31, n: 120 },
        { leader:"ä½è—¤", site:"é«˜ç”°é¦¬å ´ã‚µãƒ†ãƒ©ã‚¤ãƒˆ", votes: 28, n: 95 },
        { leader:"å±±æœ¬", site:"æ¨ªæµœæ”¯åº—", votes: 22, n: 110 },
        { leader:"ä¼Šè—¤", site:"åƒè‘‰æ”¯åº—", votes: 19, n: 80 },
      ];
      el.innerHTML = `
        <tr><th>ãƒªãƒ¼ãƒ€ãƒ¼åï¼ˆæ‹ ç‚¹åï¼‰</th><th>æ¨ã—ç¥¨æ•°</th><th>å›ç­”æ•°</th></tr>
        ${mock.map(r => `
          <tr>
            <td><strong>${escapeHtml(r.leader)}</strong> <span class="pill gray">${escapeHtml(r.site)}</span></td>
            <td>${r.votes}</td>
            <td>${r.n}</td>
          </tr>
        `).join("")}
      `;
    }
  </script>
</body>
</html>
